<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2025-07-31T08:30:08.637687"><title>TP 7 : Le Grand Portail - Mise en place de l'API Gateway | Spring Micro Services</title><script type="application/json" id="virtual-toc-data">[{"id":"objectifs-p-dagogiques","level":0,"title":"Objectifs Pédagogiques","anchor":"#objectifs-p-dagogiques"},{"id":"introduction-le-videur-prend-son-poste","level":0,"title":"Introduction : Le Videur prend son poste","anchor":"#introduction-le-videur-prend-son-poste"},{"id":"tape-1-cr-ation-du-projet-api-gateway","level":0,"title":"Étape 1 : Création du projet API Gateway","anchor":"#tape-1-cr-ation-du-projet-api-gateway"},{"id":"tape-2-configuration-du-service","level":0,"title":"Étape 2 : Configuration du service","anchor":"#tape-2-configuration-du-service"},{"id":"tape-3-sc-nario-de-test","level":0,"title":"Étape 3 : Scénario de test","anchor":"#tape-3-sc-nario-de-test"},{"id":"tape-4-dockerisation-de-l-api-gateway","level":0,"title":"Étape 4 : Dockerisation de l\u0027API Gateway","anchor":"#tape-4-dockerisation-de-l-api-gateway"},{"id":"exercice-10-ajouter-un-filtre-global","level":0,"title":"Exercice 10 : Ajouter un filtre global","anchor":"#exercice-10-ajouter-un-filtre-global"},{"id":"auto-valuation","level":0,"title":"Auto-évaluation","anchor":"#auto-valuation"},{"id":"conclusion","level":0,"title":"Conclusion","anchor":"#conclusion"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="TP 7 : Le Grand Portail - Mise en place de l'API Gateway | Spring Micro Services"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="Spring Micro Services Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/007-01-tp-7.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="TP 7 : Le Grand Portail - Mise en place de l'API Gateway | Spring Micro Services"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/007-01-tp-7.html#webpage",
    "url": "writerside-documentation/007-01-tp-7.html",
    "name": "TP 7 : Le Grand Portail - Mise en place de l'API Gateway | Spring Micro Services",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "Spring Micro Services Help"
}</script><!-- End Schema.org --></head><body data-id="007-01-TP-7" data-main-title="TP 7 : Le Grand Portail - Mise en place de l'API Gateway" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="007-00-api-gateway.md|Module 7 : La Passerelle d'API (API Gateway) (L'essentiel)"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Spring Micro Services  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="007-01-TP-7" id="007-01-TP-7.md">TP 7 : Le Grand Portail - Mise en place de l'API Gateway</h1><section class="chapter"><h2 id="objectifs-p-dagogiques" data-toc="objectifs-p-dagogiques">Objectifs P&eacute;dagogiques</h2><p id="-u92xno_12">&Agrave; la fin de ce TP, vous serez capable de :</p><ul class="list _bullet" id="-u92xno_13"><li class="list__item" id="-u92xno_14"><p id="-u92xno_20">Cr&eacute;er un projet Spring Boot pour h&eacute;berger une API Gateway.</p></li><li class="list__item" id="-u92xno_15"><p id="-u92xno_21">Ajouter et configurer les d&eacute;pendances <code class="code" id="-u92xno_22">spring-cloud-starter-gateway</code> et <code class="code" id="-u92xno_23">eureka-client</code>.</p></li><li class="list__item" id="-u92xno_16"><p id="-u92xno_24">D&eacute;finir des routes de mani&egrave;re d&eacute;clarative dans <code class="code" id="-u92xno_25">application.yml</code>.</p></li><li class="list__item" id="-u92xno_17"><p id="-u92xno_26">Utiliser la d&eacute;couverte de services (<code class="code" id="-u92xno_27">lb://</code>) pour router les requ&ecirc;tes dynamiquement.</p></li><li class="list__item" id="-u92xno_18"><p id="-u92xno_28">Valider que toutes les requ&ecirc;tes vers les services internes peuvent passer par la Gateway.</p></li><li class="list__item" id="-u92xno_19"><p id="-u92xno_29">Dockeriser l'API Gateway.</p></li></ul></section><section class="chapter"><h2 id="introduction-le-videur-prend-son-poste" data-toc="introduction-le-videur-prend-son-poste">Introduction : Le Videur prend son poste</h2><p id="-u92xno_30">Notre club &quot;GestBook&quot; a ses salles fonctionnelles (<code class="code" id="-u92xno_34">product-service</code>, <code class="code" id="-u92xno_35">order-service</code>), mais les clients entrent encore par les portes de service. Il est temps d'ouvrir la grande entr&eacute;e principale et de poster notre videur, l'**API Gateway **.</p><p id="-u92xno_31">Dans ce TP, nous allons construire ce service tr&egrave;s sp&eacute;cial. Il ne contiendra quasiment aucune logique m&eacute;tier en Java. Sa puissance r&eacute;sidera enti&egrave;rement dans sa <span class="control" id="-u92xno_36">configuration</span>. Nous allons lui apprendre &agrave; :</p><ol class="list _decimal" id="-u92xno_32" type="1"><li class="list__item" id="-u92xno_37"><p id="-u92xno_40">Se pr&eacute;senter &agrave; Eureka pour savoir o&ugrave; se trouvent les autres services.</p></li><li class="list__item" id="-u92xno_38"><p id="-u92xno_41">&Eacute;couter sur le port principal de notre application (le port 8080).</p></li><li class="list__item" id="-u92xno_39"><p id="-u92xno_42">Inspecter les requ&ecirc;tes entrantes et, en fonction de leur chemin (path), les rediriger vers le bon service interne.</p></li></ol><p id="-u92xno_33">Une fois ce TP termin&eacute;, nous n'aurons plus besoin d'appeler <code class="code" id="-u92xno_43">localhost:8081</code> ou <code class="code" id="-u92xno_44">localhost:8082</code>. Toutes nos interactions avec l'&eacute;cosyst&egrave;me se feront via un point d'entr&eacute;e unique : <code class="code" id="-u92xno_45">localhost:8080</code>, celui de la Gateway.</p></section><section class="chapter"><h2 id="tape-1-cr-ation-du-projet-api-gateway" data-toc="tape-1-cr-ation-du-projet-api-gateway">&Eacute;tape 1 : Cr&eacute;ation du projet API Gateway</h2><section class="procedure-steps" id="-u92xno_46"><p id="-u92xno_47">Comme toujours, on commence sur <a href="https://start.spring.io/" id="-u92xno_51" data-external="true" rel="noopener noreferrer" target="_blank">start.spring.io</a>.</p><p id="-u92xno_48"><b id="-u92xno_52">Configuration du projet :</b></p><ul class="list _bullet" id="-u92xno_49"><li class="list__item" id="-u92xno_53"><p><b id="-u92xno_56">Project :</b> Maven, <b id="-u92xno_57">Language :</b> Java, <b id="-u92xno_58">Spring Boot :</b> 3.2.x, <b id="-u92xno_59">Java :</b> 17</p></li><li class="list__item" id="-u92xno_54"><p><b id="-u92xno_60">Metadata :</b></p><ul class="list _bullet" id="-u92xno_61"><li class="list__item" id="-u92xno_62"><p><b id="-u92xno_65">Group :</b> <code class="code" id="-u92xno_66">fr.formation.spring</code></p></li><li class="list__item" id="-u92xno_63"><p><b id="-u92xno_67">Artifact :</b> <code class="code" id="-u92xno_68">api-gateway</code></p></li><li class="list__item" id="-u92xno_64"><p><b id="-u92xno_69">Package name :</b> <code class="code" id="-u92xno_70">fr.formation.spring.apigateway</code></p></li></ul></li><li class="list__item" id="-u92xno_55"><p><b id="-u92xno_71">Dependencies :</b></p><ul class="list _bullet" id="-u92xno_72"><li class="list__item" id="-u92xno_73"><p><code class="code" id="-u92xno_75">Gateway</code> (dans la section Spring Cloud Routing)</p></li><li class="list__item" id="-u92xno_74"><p><code class="code" id="-u92xno_76">Eureka Client</code> (dans la section Spring Cloud Discovery)</p></li></ul></li></ul><p id="-u92xno_50">G&eacute;n&eacute;rez, t&eacute;l&eacute;chargez et ouvrez le projet dans votre IDE.</p><ol class="list _decimal"></ol></section></section><section class="chapter"><h2 id="tape-2-configuration-du-service" data-toc="tape-2-configuration-du-service">&Eacute;tape 2 : Configuration du service</h2><p id="-u92xno_77">Spring Cloud Gateway se configure le plus souvent avec un fichier <code class="code" id="-u92xno_79">.yml</code>, car sa structure hi&eacute;rarchique est plus lisible qu'avec un fichier <code class="code" id="-u92xno_80">.properties</code>.</p><section class="procedure-steps" id="-u92xno_78"><p id="-u92xno_81"><b id="-u92xno_90">2.1. Cr&eacute;ation du fichier `application.yml`</b></p><p id="-u92xno_82">Dans <code class="code" id="-u92xno_91">src/main/resources</code>, supprimez le fichier <code class="code" id="-u92xno_92">application.properties</code> vide et remplacez-le par un nouveau fichier nomm&eacute; <code class="code" id="-u92xno_93">application.yml</code>.</p><p id="-u92xno_83">Copiez-y le contenu suivant :</p><div class="code-block" data-lang="yaml">
# Le port de la Gateway, c'est le point d'entrée public de notre application.
# 8080 est un choix standard.
server:
  port: 8080

# Nom de l'application

spring:
application:
name: api-gateway

cloud:
gateway:

# Activation de la découverte de services pour le routage

discovery:
locator:
enabled: true

# Permet de traduire les noms de service en minuscules avec tirets

lower-case-service-id: true

      # Définition de nos routes
      routes:
        # Première route : pour le service produit
        # On lui donne un ID unique
        - id: product-service-route
          # L'URI de destination. 'lb' signifie &quot;Load Balanced&quot;.
          # La Gateway va utiliser Eureka pour trouver une instance
          # de 'product-service'. Le nom ici est l'ID de l'application
          # enregistrée dans Eureka.
          uri: lb://product-service
          # Le prédicat qui déclenche cette route
          predicates:
            - Path=/api/products/**

        # Seconde route : pour le service commande
        - id: order-service-route
          uri: lb://order-service
          predicates:
            - Path=/api/orders/**

# Configuration du client Eureka : la Gateway doit aussi s'enregistrer

# et connaître l'adresse du serveur.

# Note : Pour l'instant, nous laissons cette configuration ici.

# Dans le TP suivant, nous la déplacerons aussi dans le Config Server.

eureka:
client:
serviceUrl:
defaultZone: http://localhost:8761/eureka

</div><p id="-u92xno_85">Cette configuration est le c&oelig;ur de notre Gateway. Elle d&eacute;finit deux r&egrave;gles de routage simples mais puissantes :</p><ul class="list _bullet" id="-u92xno_86"><li class="list__item" id="-u92xno_94"><p>Toute requ&ecirc;te dont le chemin commence par <code class="code" id="-u92xno_96">/api/products/</code> sera rout&eacute;e vers une instance de <code class="code" id="-u92xno_97">product-service</code> trouv&eacute;e via Eureka.</p></li><li class="list__item" id="-u92xno_95"><p>Toute requ&ecirc;te dont le chemin commence par <code class="code" id="-u92xno_98">/api/orders/</code> sera rout&eacute;e vers une instance de <code class="code" id="-u92xno_99">order-service</code> trouv&eacute;e via Eureka.</p></li></ul><p id="-u92xno_87"><b id="-u92xno_100">2.2. La classe principale</b></p><p id="-u92xno_88">La classe principale <code class="code" id="-u92xno_101">ApiGatewayApplication.java</code> ne n&eacute;cessite aucune annotation particuli&egrave;re. Les d&eacute;pendances que nous avons ajout&eacute;es suffisent &agrave; activer la Gateway et le client Eureka.</p><div class="code-block" data-lang="java">
// package fr.formation.spring.apigateway;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class ApiGatewayApplication {

    public static void main(String[] args) {
        SpringApplication.run(ApiGatewayApplication.class, args);
    }
}
</div><ol class="list _decimal"></ol></section></section><section class="chapter"><h2 id="tape-3-sc-nario-de-test" data-toc="tape-3-sc-nario-de-test">&Eacute;tape 3 : Sc&eacute;nario de test</h2><p id="-u92xno_102">Il est temps de v&eacute;rifier que notre portail fonctionne.</p><section class="procedure-steps" id="-u92xno_103"><p id="-u92xno_106"><b id="-u92xno_118">3.1. Pr&eacute;paration de l'environnement</b></p><ol class="list _decimal" id="-u92xno_107" type="1"><li class="list__item" id="-u92xno_119"><p>Si ce n'est pas d&eacute;j&agrave; fait, assurez-vous que les conteneurs Docker de <code class="code" id="-u92xno_125">eureka-server</code> et <code class="code" id="-u92xno_126">config-server</code> sont lanc&eacute;s.</p></li><li class="list__item" id="-u92xno_120"><p>Lancez le <code class="code" id="-u92xno_127">product-service</code> depuis votre IDE.</p></li><li class="list__item" id="-u92xno_121"><p>Lancez le <code class="code" id="-u92xno_128">order-service</code> depuis votre IDE.</p></li><li class="list__item" id="-u92xno_122"><p>V&eacute;rifiez dans le dashboard Eureka que ces deux services sont bien enregistr&eacute;s.</p></li><li class="list__item" id="-u92xno_123"><p>Maintenant, <b id="-u92xno_129">lancez le projet <code class="code" id="-u92xno_130">api-gateway</code></b> depuis votre IDE.</p></li><li class="list__item" id="-u92xno_124"><p>V&eacute;rifiez le dashboard Eureka : vous devriez maintenant voir 3 services enregistr&eacute;s : `PRODUCT-SERVICE`, `ORDER-SERVICE` et `API-GATEWAY`.</p></li></ol><p id="-u92xno_108"><b id="-u92xno_131">3.2. Test du routage</b></p><p id="-u92xno_109">Ouvrez votre client HTTP. Nous n'allons plus utiliser les ports 8081 et 8082. Tous les appels se feront sur le port <b id="-u92xno_132">8080</b> de la Gateway.</p><p id="-u92xno_110"><b id="-u92xno_133">Test 1 : Acc&eacute;der aux produits via la Gateway</b></p><p id="-u92xno_111">Faites un appel qui, avant, allait sur <code class="code" id="-u92xno_134">localhost:8081/api/products</code>.</p><p> <code class="code" id="-u92xno_112">### Get all products VIA GATEWAY GET http://localhost:8080/api/products Accept: application/json</code></p><p id="-u92xno_113">Vous devriez recevoir la liste des produits, exactement comme avant ! La Gateway a correctement rout&eacute; votre requ&ecirc;te vers le <code class="code" id="-u92xno_135">product-service</code>.</p><p id="-u92xno_114"><b id="-u92xno_136">Test 2 : Cr&eacute;er une commande via la Gateway</b></p><p id="-u92xno_115">Faites un appel qui, avant, allait sur <code class="code" id="-u92xno_137">localhost:8082/api/orders</code>.</p><div class="code-block" data-lang="http">
### Create an order VIA GATEWAY
POST http://localhost:8080/api/orders
Content-Type: application/json

{
&quot;productId&quot;: 1,
&quot;quantity&quot;: 1
}
</div><p id="-u92xno_117">Vous devriez recevoir une r&eacute;ponse `201 Created` avec le corps de la commande. La Gateway a rout&eacute; l'appel vers `order-service`, qui a lui-m&ecirc;me appel&eacute; `product-service` (via Feign et Eureka). La cha&icirc;ne de communication est compl&egrave;te !</p><ol class="list _decimal"></ol></section><p id="-u92xno_104">Diagramme de la requ&ecirc;te de cr&eacute;ation de commande via la Gateway :</p><style>.theme-dark .plantuml > svg {filter: hue-rotate(180deg) invert(0.9);}div.plantuml {overflow-x: auto;}</style><div class="plantuml"><?xml version="1.0" encoding="us-ascii" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="496px" preserveAspectRatio="none" style="width:690px;height:496px;background:#FFFFFF;" version="1.1" viewBox="0 0 690 496" width="690px" zoomAndPan="magnify"><defs/><g><rect fill="#FFFFFF" height="89.3979" style="stroke:#000000;stroke-width:1.0;" width="10" x="162.5" y="114.814"/><rect fill="#FFFFFF" height="191.7959" style="stroke:#000000;stroke-width:1.0;" width="10" x="312" y="204.2119"/><rect fill="#FFFFFF" height="29.7993" style="stroke:#000000;stroke-width:1.0;" width="10" x="475" y="293.6099"/><rect fill="#FFFFFF" height="29.7993" style="stroke:#000000;stroke-width:1.0;" width="10" x="623" y="144.6133"/><rect fill="#FFFFFF" height="29.7993" style="stroke:#000000;stroke-width:1.0;" width="10" x="623" y="234.0112"/><line style="stroke:#000000;stroke-width:1.0;" x1="28" x2="28" y1="83.0146" y2="414.0078"/><line style="stroke:#000000;stroke-width:1.0;" x1="167" x2="167" y1="83.0146" y2="414.0078"/><line style="stroke:#000000;stroke-width:1.0;" x1="317" x2="317" y1="83.0146" y2="414.0078"/><line style="stroke:#000000;stroke-width:1.0;" x1="479.5" x2="479.5" y1="83.0146" y2="414.0078"/><line style="stroke:#000000;stroke-width:1.0;" x1="627.5" x2="627.5" y1="83.0146" y2="414.0078"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="31" x="10" y="80.0752">User</text><ellipse cx="28.5" cy="14" fill="#FFFFFF" rx="8" ry="8" style="stroke:#000000;stroke-width:1.0;"/><path d="M28.5,22 L28.5,49 M15.5,30 L41.5,30 M28.5,49 L15.5,64 M28.5,49 L41.5,64 " fill="none" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="31" x="10" y="427.083">User</text><ellipse cx="28.5" cy="439.0225" fill="#FFFFFF" rx="8" ry="8" style="stroke:#000000;stroke-width:1.0;"/><path d="M28.5,447.0225 L28.5,474.0225 M15.5,455.0225 L41.5,455.0225 M28.5,474.0225 L15.5,489.0225 M28.5,474.0225 L41.5,489.0225 " fill="none" style="stroke:#000000;stroke-width:1.0;"/><rect fill="#FFFFFF" height="48.0293" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="129" x="103" y="33.9854"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="89" x="123" y="55.0605">API Gateway</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="115" x="110" y="72.0752">(localhost:8080)</text><rect fill="#FFFFFF" height="48.0293" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="129" x="103" y="413.0078"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="89" x="123" y="434.083">API Gateway</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="115" x="110" y="451.0977">(localhost:8080)</text><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="110" x="262" y="51"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="96" x="269" y="72.0752">Order Service</text><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="110" x="262" y="413.0078"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="96" x="269" y="434.083">Order Service</text><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="123" x="418.5" y="51"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="109" x="425.5" y="72.0752">Product Service</text><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="123" x="418.5" y="413.0078"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="109" x="425.5" y="434.083">Product Service</text><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="113" x="571.5" y="51"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="99" x="578.5" y="72.0752">Eureka Server</text><rect fill="#FFFFFF" height="31.0146" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="113" x="571.5" y="413.0078"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="99" x="578.5" y="434.083">Eureka Server</text><rect fill="#FFFFFF" height="89.3979" style="stroke:#000000;stroke-width:1.0;" width="10" x="162.5" y="114.814"/><rect fill="#FFFFFF" height="191.7959" style="stroke:#000000;stroke-width:1.0;" width="10" x="312" y="204.2119"/><rect fill="#FFFFFF" height="29.7993" style="stroke:#000000;stroke-width:1.0;" width="10" x="475" y="293.6099"/><rect fill="#FFFFFF" height="29.7993" style="stroke:#000000;stroke-width:1.0;" width="10" x="623" y="144.6133"/><rect fill="#FFFFFF" height="29.7993" style="stroke:#000000;stroke-width:1.0;" width="10" x="623" y="234.0112"/><polygon fill="#000000" points="150.5,110.814,160.5,114.814,150.5,118.814,154.5,114.814" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="28.5" x2="156.5" y1="114.814" y2="114.814"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="115" x="35.5" y="110.0845">POST /api/orders</text><polygon fill="#000000" points="611,140.6133,621,144.6133,611,148.6133,615,144.6133" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="172.5" x2="617" y1="144.6133" y2="144.6133"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="172" x="179.5" y="139.8838">Discover("order-service")</text><polygon fill="#000000" points="183.5,170.4126,173.5,174.4126,183.5,178.4126,179.5,174.4126" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="177.5" x2="627" y1="174.4126" y2="174.4126"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="51" x="189.5" y="169.6831">IP:8082</text><polygon fill="#000000" points="300,200.2119,310,204.2119,300,208.2119,304,204.2119" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="167.5" x2="306" y1="204.2119" y2="204.2119"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="115" x="174.5" y="199.4824">POST /api/orders</text><polygon fill="#000000" points="611,230.0112,621,234.0112,611,238.0112,615,234.0112" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="322" x2="617" y1="234.0112" y2="234.0112"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="186" x="329" y="229.2817">Discover("product-service")</text><polygon fill="#000000" points="333,259.8105,323,263.8105,333,267.8105,329,263.8105" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="327" x2="627" y1="263.8105" y2="263.8105"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="51" x="339" y="259.0811">IP:8081</text><polygon fill="#000000" points="463,289.6099,473,293.6099,463,297.6099,467,293.6099" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="322" x2="469" y1="293.6099" y2="293.6099"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="134" x="329" y="288.8804">GET /api/products/1</text><polygon fill="#000000" points="333,319.4092,323,323.4092,333,327.4092,329,323.4092" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="327" x2="479" y1="323.4092" y2="323.4092"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="48" x="339" y="318.6797">200 OK</text><line style="stroke:#000000;stroke-width:1.0;" x1="322" x2="364" y1="353.2085" y2="353.2085"/><line style="stroke:#000000;stroke-width:1.0;" x1="364" x2="364" y1="353.2085" y2="366.2085"/><line style="stroke:#000000;stroke-width:1.0;" x1="323" x2="364" y1="366.2085" y2="366.2085"/><polygon fill="#000000" points="333,362.2085,323,366.2085,333,370.2085,329,366.2085" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="126" x="329" y="348.479">Cr&#233;e la commande</text><polygon fill="#000000" points="39.5,392.0078,29.5,396.0078,39.5,400.0078,35.5,396.0078" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="33.5" x2="316" y1="396.0078" y2="396.0078"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="81" x="45.5" y="391.2783">201 Created</text><!--SRC=[VP2nJiCm48PtFyMHgHsg99sg34W8hAXYiAM0M5WivwHQ975akqKy4i_1Yt5EGfi0wcRflll-_tmJ3jWYz8qo7LCwM0VF7XthbGj6crvr0P8xkOTI1NnN7w_Tgh5QDGVhGx7BTjaw0UMXV5bk25UZWmhToMWS254j2UbiVTHXmSXV33ywV5C3WcuWE6En7cnkAH8AaA9wWbJr9hKnqSSJp8cgnaP44CS9Up1UMtAiaW7R-2bqVU4vux3vqUvbl6tBQfpDHvse_ekTWHHyVjFHZ1R-jEZ7uw_r67B67lconoYKSLxogSOaz6b-CT5l4dHsRRCCnEDSHS3e4bK1z-xh4w5He6tRggx6OKR3-DznEoS4QQsUA-Z0Rm00]--></g></svg></div></section><section class="chapter"><h2 id="tape-4-dockerisation-de-l-api-gateway" data-toc="tape-4-dockerisation-de-l-api-gateway">&Eacute;tape 4 : Dockerisation de l'API Gateway</h2><p id="-u92xno_138">La proc&eacute;dure est maintenant une routine bien connue.</p><ol class="list _decimal" id="-u92xno_139" type="1"><li class="list__item" id="-u92xno_144"><p id="-u92xno_145">Cr&eacute;ez le <code class="code" id="-u92xno_146">Dockerfile</code> &agrave; la racine du projet <code class="code" id="-u92xno_147">api-gateway</code>.</p></li></ol><div class="code-block" data-lang="dockerfile">
   # ----- STAGE 1: Build -----
   FROM maven:3.8.5-openjdk-17 AS build
   WORKDIR /app
   COPY pom.xml .
   RUN mvn dependency:go-offline
   COPY src ./src
   RUN mvn package -DskipTests

   # ----- STAGE 2: Runtime -----
   FROM eclipse-temurin:17-jre-focal
   WORKDIR /app
   COPY --from=build /app/target/*.jar app.jar
   EXPOSE 8080
   ENTRYPOINT [&quot;java&quot;, &quot;-jar&quot;, &quot;app.jar&quot;]
</div><ol class="list _decimal" id="-u92xno_141" type="1" start="2"><li class="list__item" id="-u92xno_148"><p id="-u92xno_149">Construisez l'image :</p></li></ol><div class="code-block" data-lang="bash">
    mvn clean package
   docker build -t api-gateway:1.0 .
</div></section><section class="chapter"><h2 id="exercice-10-ajouter-un-filtre-global" data-toc="exercice-10-ajouter-un-filtre-global">Exercice 10 : Ajouter un filtre global</h2><p id="-u92xno_150"><span class="control" id="-u92xno_155">Contexte :</span> Pour des raisons de d&eacute;bogage, nous voulons que chaque requ&ecirc;te qui passe par la Gateway se voie ajouter un en-t&ecirc;te (header) HTTP sp&eacute;cifique, par exemple <code class="code" id="-u92xno_156">X-Request-Source: api-gateway</code>.</p><p id="-u92xno_151"><span class="control" id="-u92xno_157">Votre mission :</span></p><ol class="list _decimal" id="-u92xno_152" type="1"><li class="list__item" id="-u92xno_158"><p id="-u92xno_163">Modifiez le fichier <code class="code" id="-u92xno_164">application.yml</code> de l'API Gateway.</p></li><li class="list__item" id="-u92xno_159"><p id="-u92xno_165">Ajoutez une section <code class="code" id="-u92xno_166">default-filters</code> au niveau de la configuration de la gateway.</p></li><li class="list__item" id="-u92xno_160"><p id="-u92xno_167">Utilisez le filtre <code class="code" id="-u92xno_168">AddRequestHeader</code> pour ajouter l'en-t&ecirc;te <code class="code" id="-u92xno_169">X-Request-Source</code> avec la valeur <code class="code" id="-u92xno_170">api-gateway</code>.</p></li><li class="list__item" id="-u92xno_161"><p id="-u92xno_171">Red&eacute;marrez la Gateway et faites un appel &agrave; <code class="code" id="-u92xno_172">GET /api/products/1</code>.</p></li><li class="list__item" id="-u92xno_162"><p id="-u92xno_173">Dans la console de <code class="code" id="-u92xno_174">product-service</code>, modifiez le <code class="code" id="-u92xno_175">ProductController</code> pour qu'il affiche les en-t&ecirc;tes de la requ&ecirc;te re&ccedil;ue et v&eacute;rifiez que le nouvel en-t&ecirc;te est bien pr&eacute;sent.</p></li></ol><p id="-u92xno_153"><span class="control" id="-u92xno_176">Indice :</span> La structure YAML pour les filtres par d&eacute;faut est <code class="code" id="-u92xno_177">spring.cloud.gateway.default-filters</code>.</p><section class="chapter"><div class="collapse"><div class="collapse__title"><h3 id="correction-exercice-10" data-toc="correction-exercice-10">Correction exercice 10</h3></div><div class="collapse__content"><ol class="list _decimal" id="-u92xno_178" type="1"><li class="list__item" id="-u92xno_180"><p id="-u92xno_183">et 2. Voici le <code class="code" id="-u92xno_186">application.yml</code> de l'API Gateway modifi&eacute; :</p><div class="code-block" data-lang="yaml">
# ... (server, spring.application.name)
spring:
  application:
    name: api-gateway
  cloud:
    gateway:
      # ... (discovery, routes)
      # Ajout des filtres par défaut
      default-filters:
        - AddRequestHeader=X-Request-Source, api-gateway
# ... (eureka)
</div><p id="-u92xno_185">Cette configuration simple appliquera ce filtre &agrave; TOUTES les routes d&eacute;finies.</p></li><li class="list__item" id="-u92xno_181"><p id="-u92xno_187">Apr&egrave;s avoir red&eacute;marr&eacute; la Gateway, il faut modifier le <code class="code" id="-u92xno_189">ProductController</code> pour observer le r&eacute;sultat.</p><div class="code-block" data-lang="java">
// Dans ProductController.java du projet product-service

// ...
@GetMapping(&quot;/{id}&quot;)
public ResponseEntity&lt;Product&gt; getProductById(
    @PathVariable Long id,
    @RequestHeader(required = false, name = &quot;X-Request-Source&quot;) String source
) {
    System.out.println(&quot;Requête reçue de : &quot; + (source != null ? source : &quot;Inconnu&quot;));
    Optional&lt;Product&gt; product = productRepository.findById(id);
    return product.map(ResponseEntity::ok)
                  .orElseGet(() -&gt; ResponseEntity.notFound().build());
}
// ...
</div></li><li class="list__item" id="-u92xno_182"><p id="-u92xno_190">Relancez <code class="code" id="-u92xno_193">product-service</code> et <code class="code" id="-u92xno_194">api-gateway</code>. Lorsque vous appelez <code class="code" id="-u92xno_195">http://localhost:8080/api/products/1</code>, vous verrez dans la console du <span class="control" id="-u92xno_196">product-service</span> le message :</p><div class="code-block" data-lang="none">
Requête reçue de : api-gateway
</div><p id="-u92xno_192">Cela prouve que la Gateway a bien intercept&eacute; la requ&ecirc;te, ajout&eacute; l'en-t&ecirc;te, et l'a ensuite transmise. C'est un exemple simple de la puissance des filtres.</p></li></ol></div></div></section></section><section class="chapter"><h2 id="auto-valuation" data-toc="auto-valuation">Auto-&eacute;valuation</h2><ol class="list _decimal" id="-u92xno_197" type="1"><li class="list__item" id="-u92xno_199"><p id="-u92xno_204"><span class="control" id="-u92xno_206">(QCM)</span> Quelle est la d&eacute;pendance Maven principale pour cr&eacute;er une API Gateway avec Spring Cloud ?</p><ul class="list _bullet" id="-u92xno_205"><li class="list__item" id="-u92xno_207"><p id="-u92xno_211">A) <code class="code" id="-u92xno_212">spring-cloud-starter-openfeign</code></p></li><li class="list__item" id="-u92xno_208"><p id="-u92xno_213">B) <code class="code" id="-u92xno_214">spring-cloud-starter-gateway</code></p></li><li class="list__item" id="-u92xno_209"><p id="-u92xno_215">C) <code class="code" id="-u92xno_216">spring-cloud-starter-netflix-zuul</code></p></li><li class="list__item" id="-u92xno_210"><p id="-u92xno_217">D) <code class="code" id="-u92xno_218">spring-boot-starter-web</code></p></li></ul></li><li class="list__item" id="-u92xno_200"><p id="-u92xno_219"><span class="control" id="-u92xno_220">(Question ouverte)</span> Dans la configuration d'une route de la Gateway, expliquez la diff&eacute;rence entre <code class="code" id="-u92xno_221">uri</code> et <code class="code" id="-u92xno_222">predicates</code>.</p></li><li class="list__item" id="-u92xno_201"><p id="-u92xno_223"><span class="control" id="-u92xno_225">(QCM)</span> Pour router les requ&ecirc;tes vers <code class="code" id="-u92xno_226">/utilisateurs/123/details</code> vers un service nomm&eacute; <code class="code" id="-u92xno_227">user-service</code>, quel pr&eacute;dicat est le plus appropri&eacute; ?</p><ul class="list _bullet" id="-u92xno_224"><li class="list__item" id="-u92xno_228"><p id="-u92xno_232">A) <code class="code" id="-u92xno_233">Path=/utilisateurs/**</code></p></li><li class="list__item" id="-u92xno_229"><p id="-u92xno_234">B) <code class="code" id="-u92xno_235">Host=user-service.com</code></p></li><li class="list__item" id="-u92xno_230"><p id="-u92xno_236">C) <code class="code" id="-u92xno_237">Method=GET</code></p></li><li class="list__item" id="-u92xno_231"><p id="-u92xno_238">D) <code class="code" id="-u92xno_239">Header=Content-Type, application/json</code></p></li></ul></li><li class="list__item" id="-u92xno_202"><p id="-u92xno_240"><span class="control" id="-u92xno_241">(Question ouverte)</span> Pourquoi le projet Spring Cloud Gateway est-il bas&eacute; sur Spring WebFlux (le stack r&eacute;actif) plut&ocirc;t que sur Spring Web MVC (le stack servlet traditionnel) ?</p></li><li class="list__item" id="-u92xno_203"><p id="-u92xno_242"><span class="control" id="-u92xno_244">(QCM)</span> Si on ne sp&eacute;cifie pas de routes dans le <code class="code" id="-u92xno_245">application.yml</code>, que fait la Gateway par d&eacute;faut ?</p><ul class="list _bullet" id="-u92xno_243"><li class="list__item" id="-u92xno_246"><p id="-u92xno_250">A) Elle refuse toutes les requ&ecirc;tes.</p></li><li class="list__item" id="-u92xno_247"><p id="-u92xno_251">B) Elle route toutes les requ&ecirc;tes vers un service par d&eacute;faut nomm&eacute; &quot;default-service&quot;.</p></li><li class="list__item" id="-u92xno_248"><p id="-u92xno_252">C) Si <code class="code" id="-u92xno_253">discovery.locator</code> est activ&eacute;, elle cr&eacute;e des routes dynamiquement pour chaque service trouv&eacute; dans Eureka ( ex: <code class="code" id="-u92xno_254">/product-service/**</code>-&gt; <code class="code" id="-u92xno_255">product-service</code>).</p></li><li class="list__item" id="-u92xno_249"><p id="-u92xno_256">D) Elle plante au d&eacute;marrage.</p></li></ul></li></ol></section><section class="chapter"><h2 id="conclusion" data-toc="conclusion">Conclusion</h2><p id="-u92xno_257">Le gardien est en place ! Vous avez construit, configur&eacute; et test&eacute; une <span class="control" id="-u92xno_260">API Gateway</span>, le point d'entr&eacute;e unique et s&eacute;curis&eacute; de votre &eacute;cosyst&egrave;me. Vous avez vu &agrave; quel point il est simple, avec Spring Cloud Gateway, de d&eacute;finir des r&egrave;gles de <span class="control" id="-u92xno_261">routage</span> bas&eacute;es sur des <span class="control" id="-u92xno_262">pr&eacute;dicats</span> et d'enrichir les requ&ecirc;tes avec des <span class="control" id="-u92xno_263">filtres</span>.</p><p id="-u92xno_258">Tous nos services sont maintenant cach&eacute;s derri&egrave;re cette fa&ccedil;ade, ce qui simplifie &eacute;norm&eacute;ment la vie des clients de l'API et centralise la gestion des probl&eacute;matiques transversales.</p><p id="-u92xno_259">Nous avons maintenant toutes les briques de notre architecture : des services m&eacute;tier, un annuaire, un serveur de configuration, une gateway... mais les lancer toutes manuellement est devenu un v&eacute;ritable calvaire. Il est temps d'apprendre &agrave; les orchestrer. Dans le prochain module, nous allons d&eacute;couvrir <span class="control" id="-u92xno_264">Docker Compose</span> pour lancer toute notre pile avec une seule commande.</p></section><div class="last-modified">17 juillet 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="007-00-api-gateway.html" class="navigation-links__prev">Module 7 : La Passerelle d'API (API Gateway) (L'essentiel)</a><a href="008-00-docker-compose.html" class="navigation-links__next">Module 8 : Orchestration avec Docker Compose (L'essentiel)</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.js"></script></body></html>