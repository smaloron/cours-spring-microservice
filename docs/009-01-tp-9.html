<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2025-07-31T13:08:47.310402"><title>TP 9 : &quot;Montrez patte blanche&quot; - S&eacute;curisation de l'API avec Keycloak et Spring Security | Spring Micro Services</title><script type="application/json" id="virtual-toc-data">[{"id":"objectifs-p-dagogiques","level":0,"title":"Objectifs Pédagogiques","anchor":"#objectifs-p-dagogiques"},{"id":"introduction-mettre-en-place-le-service-de-s-curit","level":0,"title":"Introduction : Mettre en place le service de sécurité","anchor":"#introduction-mettre-en-place-le-service-de-s-curit"},{"id":"tape-1-ajout-de-keycloak-docker-compose","level":0,"title":"Étape 1 : Ajout de Keycloak à Docker Compose","anchor":"#tape-1-ajout-de-keycloak-docker-compose"},{"id":"tape-2-configuration-de-keycloak","level":0,"title":"Étape 2 : Configuration de Keycloak","anchor":"#tape-2-configuration-de-keycloak"},{"id":"tape-3-transformer-product-service-en-resource-server","level":0,"title":"Étape 3 : Transformer product-service en Resource Server","anchor":"#tape-3-transformer-product-service-en-resource-server"},{"id":"tape-4-le-grand-test","level":0,"title":"Étape 4 : Le Grand Test","anchor":"#tape-4-le-grand-test"},{"id":"exercice-12-tester-avec-le-mauvais-r-le","level":0,"title":"Exercice 12 : Tester avec le mauvais rôle","anchor":"#exercice-12-tester-avec-le-mauvais-r-le"},{"id":"auto-valuation","level":0,"title":"Auto-évaluation","anchor":"#auto-valuation"},{"id":"conclusion","level":0,"title":"Conclusion","anchor":"#conclusion"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="TP 9 : &quot;Montrez patte blanche&quot; - S&eacute;curisation de l'API avec Keycloak et Spring Security | Spring Micro Services"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="Spring Micro Services Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/009-01-tp-9.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="TP 9 : &quot;Montrez patte blanche&quot; - S&eacute;curisation de l'API avec Keycloak et Spring Security | Spring Micro Services"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/009-01-tp-9.html#webpage",
    "url": "writerside-documentation/009-01-tp-9.html",
    "name": "TP 9 : &quot;Montrez patte blanche&quot; - S&eacute;curisation de l'API avec Keycloak et Spring Security | Spring Micro Services",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "Spring Micro Services Help"
}</script><!-- End Schema.org --></head><body data-id="009-01-TP-9" data-main-title="TP 9 : &quot;Montrez patte blanche&quot; - Sécurisation de l'API avec Keycloak et Spring Security" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="009-00-security.md|Module 9 : Sécurité Avancée avec Spring Security &amp; OAuth2/OIDC (L'essentiel)"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Spring Micro Services  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="009-01-TP-9" id="009-01-TP-9.md">TP 9 : &quot;Montrez patte blanche&quot; - Sécurisation de l'API avec Keycloak et Spring Security</h1><section class="chapter"><h2 id="objectifs-p-dagogiques" data-toc="objectifs-p-dagogiques">Objectifs P&eacute;dagogiques</h2><p id="-pzc9yg_12">&Agrave; la fin de ce TP, vous serez capable de :</p><ul class="list _bullet" id="-pzc9yg_13"><li class="list__item" id="-pzc9yg_14"><p id="-pzc9yg_20">Ajouter Keycloak &agrave; l'orchestration Docker Compose.</p></li><li class="list__item" id="-pzc9yg_15"><p id="-pzc9yg_21">Configurer un &quot;realm&quot;, un &quot;client&quot; et des &quot;utilisateurs/r&ocirc;les&quot; dans Keycloak.</p></li><li class="list__item" id="-pzc9yg_16"><p id="-pzc9yg_22">Configurer un microservice Spring Boot en tant que &quot;Resource Server&quot; OAuth2.</p></li><li class="list__item" id="-pzc9yg_17"><p id="-pzc9yg_23">Prot&eacute;ger des endpoints sp&eacute;cifiques en se basant sur les r&ocirc;les des utilisateurs.</p></li><li class="list__item" id="-pzc9yg_18"><p id="-pzc9yg_24">Obtenir un token JWT depuis Keycloak.</p></li><li class="list__item" id="-pzc9yg_19"><p id="-pzc9yg_25">Tester des endpoints s&eacute;curis&eacute;s et non s&eacute;curis&eacute;s avec un client REST.</p></li></ul></section><section class="chapter"><h2 id="introduction-mettre-en-place-le-service-de-s-curit" data-toc="introduction-mettre-en-place-le-service-de-s-curit">Introduction : Mettre en place le service de s&eacute;curit&eacute;</h2><p id="-pzc9yg_26">Notre club &quot;GestBook&quot; a besoin de son agence de s&eacute;curit&eacute;. Nous allons &quot;embaucher&quot; <span class="control" id="-pzc9yg_29">Keycloak</span> en l'ajoutant &agrave; notre <code class="code" id="-pzc9yg_30">docker-compose.yml</code>. Une fois Keycloak op&eacute;rationnel, nous allons le briefer :</p><ol class="list _decimal" id="-pzc9yg_27" type="1"><li class="list__item" id="-pzc9yg_31"><p id="-pzc9yg_34">Cr&eacute;er notre propre p&eacute;rim&egrave;tre de s&eacute;curit&eacute; (un <code class="code" id="-pzc9yg_35">realm</code>).</p></li><li class="list__item" id="-pzc9yg_32"><p id="-pzc9yg_36">Lui d&eacute;clarer notre application (un <code class="code" id="-pzc9yg_37">client</code>).</p></li><li class="list__item" id="-pzc9yg_33"><p id="-pzc9yg_38">Cr&eacute;er les cartes d'identit&eacute; pour nos employ&eacute;s et nos clients (des <code class="code" id="-pzc9yg_39">users</code> et des <code class="code" id="-pzc9yg_40">roles</code>).</p></li></ol><p id="-pzc9yg_28">Ensuite, nous apprendrons &agrave; notre <code class="code" id="-pzc9yg_41">product-service</code> &agrave; parler &agrave; Keycloak. Nous allons le transformer en &quot;Resource Server&quot; qui saura, pour chaque requ&ecirc;te, v&eacute;rifier la validit&eacute; du &quot;laissez-passer&quot; (le token JWT) et les droits qui y sont associ&eacute;s. &Agrave; la fin, l'ajout d'un nouveau livre ne sera possible que pour un utilisateur ayant le r&ocirc;le d'administrateur.</p></section><section class="chapter"><h2 id="tape-1-ajout-de-keycloak-docker-compose" data-toc="tape-1-ajout-de-keycloak-docker-compose">&Eacute;tape 1 : Ajout de Keycloak &agrave; Docker Compose</h2><section class="procedure-steps" id="-pzc9yg_42"><p id="-pzc9yg_43">Ouvrez votre fichier <code class="code" id="-pzc9yg_49">docker-compose.yml</code> &agrave; la racine du projet.</p><p id="-pzc9yg_44">Ajoutez un nouveau service pour Keycloak. Il est ind&eacute;pendant des autres, il n'a donc pas besoin de <code class="code" id="-pzc9yg_50">depends_on</code>, mais les autres services d&eacute;pendront de lui.</p><div class="code-block" data-lang="yaml">
# Dans docker-compose.yml
services:
  # ... (config-server, eureka-server, etc.)

  # 6. Le Serveur d'Autorisation Keycloak
  keycloak:
    image: quay.io/keycloak/keycloak:24.0.2 # Utilisez une version récente
    ports:
      - &quot;9090:8080&quot; # On mappe le port 8080 de Keycloak au 9090 de notre machine
    environment:
      # Identifiants pour l'admin de Keycloak
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
    # Commande pour démarrer Keycloak en mode développement
    command: start-dev

# ...
</div><p id="-pzc9yg_46">Lancez Keycloak pour la premi&egrave;re fois pour v&eacute;rifier que tout fonctionne :</p><p id="-pzc9yg_48">Attendez que Keycloak ait fini de d&eacute;marrer. Ouvrez votre navigateur &agrave; l'adresse <a href="http://localhost:9090/" id="-pzc9yg_51" data-external="true" rel="noopener noreferrer" target="_blank">http://localhost:9090/</a>. Vous devriez voir la page d'accueil de Keycloak. Cliquez sur &quot;Administration Console&quot; et connectez-vous avec les identifiants que nous avons d&eacute;finis : `admin` / `admin`.</p><ol class="list _decimal"></ol></section></section><section class="chapter"><h2 id="tape-2-configuration-de-keycloak" data-toc="tape-2-configuration-de-keycloak">&Eacute;tape 2 : Configuration de Keycloak</h2><p id="-pzc9yg_52">Nous allons maintenant configurer notre environnement de s&eacute;curit&eacute; via l'interface web de Keycloak.</p><section class="procedure-steps" id="-pzc9yg_53"><p id="-pzc9yg_54"><b id="-pzc9yg_68">2.1. Cr&eacute;er un &quot;Realm&quot;</b></p><p id="-pzc9yg_55">Un realm est un espace de s&eacute;curit&eacute; isol&eacute;. Par d&eacute;faut, vous &ecirc;tes dans le realm `master`. Il est recommand&eacute; de cr&eacute;er un realm d&eacute;di&eacute; pour nos applications.</p><ol class="list _decimal" id="-pzc9yg_56" type="1"><li class="list__item" id="-pzc9yg_69"><p>Passez votre souris sur &quot;master&quot; en haut &agrave; gauche et cliquez sur &quot;Create Realm&quot;.</p></li><li class="list__item" id="-pzc9yg_70"><p>Nom du Realm : <code class="code" id="-pzc9yg_72">gestbook-realm</code>.</p></li><li class="list__item" id="-pzc9yg_71"><p>Cliquez sur &quot;Create&quot;. Vous &ecirc;tes maintenant dans votre nouveau realm.</p></li></ol><figure id="-pzc9yg_57"><img alt="Cr&eacute;er un Realm Keycloak" src="${primarySource}" title="Cr&eacute;er un Realm Keycloak"></figure><p id="-pzc9yg_58"><b id="-pzc9yg_73">2.2. Cr&eacute;er un &quot;Client&quot;</b></p><p id="-pzc9yg_59">Un client repr&eacute;sente une application qui va &ecirc;tre s&eacute;curis&eacute;e par Keycloak.</p><ol class="list _decimal" id="-pzc9yg_60" type="1"><li class="list__item" id="-pzc9yg_74"><p>Dans le menu de gauche, allez dans &quot;Clients&quot;.</p></li><li class="list__item" id="-pzc9yg_75"><p>Cliquez sur &quot;Create client&quot;.</p></li><li class="list__item" id="-pzc9yg_76"><p><b id="-pzc9yg_79">Client ID :</b> <code class="code" id="-pzc9yg_80">gestbook-api</code> (c'est le nom technique de notre application).</p></li><li class="list__item" id="-pzc9yg_77"><p>Cliquez sur &quot;Next&quot;.</p></li><li class="list__item" id="-pzc9yg_78"><p>Laissez les options par d&eacute;faut et cliquez sur &quot;Save&quot;.</p></li></ol><p id="-pzc9yg_61"><b id="-pzc9yg_81">2.3. Cr&eacute;er des R&ocirc;les</b></p><p id="-pzc9yg_62">Nous avons besoin de r&ocirc;les pour d&eacute;finir les autorisations.</p><ol class="list _decimal" id="-pzc9yg_63" type="1"><li class="list__item" id="-pzc9yg_82"><p>Dans le menu de gauche, allez dans &quot;Realm Roles&quot;.</p></li><li class="list__item" id="-pzc9yg_83"><p>Cliquez sur &quot;Create role&quot;.</p></li><li class="list__item" id="-pzc9yg_84"><p><b id="-pzc9yg_87">Role Name :</b> <code class="code" id="-pzc9yg_88">ROLE_ADMIN</code>. Cliquez sur &quot;Save&quot;.</p></li><li class="list__item" id="-pzc9yg_85"><p>Cliquez &agrave; nouveau sur &quot;Create role&quot;.</p></li><li class="list__item" id="-pzc9yg_86"><p><b id="-pzc9yg_89">Role Name :</b> <code class="code" id="-pzc9yg_90">ROLE_USER</code>. Cliquez sur &quot;Save&quot;.</p></li></ol><aside class="prompt" data-type="warning" data-title="" id="-pzc9yg_64"><p><b id="-pzc9yg_91">Convention de nommage Spring Security</b></p><p id="-pzc9yg_92">Il est tr&egrave;s courant de pr&eacute;fixer les r&ocirc;les avec <code class="code" id="-pzc9yg_93">ROLE_</code>. Spring Security peut &ecirc;tre configur&eacute; pour l'attendre par d&eacute;faut, c'est donc une bonne pratique &agrave; prendre.</p></aside><p id="-pzc9yg_65"><b id="-pzc9yg_94">2.4. Cr&eacute;er des Utilisateurs</b></p><ol class="list _decimal" id="-pzc9yg_66" type="1"><li class="list__item" id="-pzc9yg_95"><p>Dans le menu de gauche, allez dans &quot;Users&quot;.</p></li><li class="list__item" id="-pzc9yg_96"><p>Cliquez sur &quot;Create new user&quot;.</p></li><li class="list__item" id="-pzc9yg_97"><p><b id="-pzc9yg_103">Username :</b> <code class="code" id="-pzc9yg_104">admin-user</code>. Cliquez sur &quot;Create&quot;.</p></li><li class="list__item" id="-pzc9yg_98"><p>Allez dans l'onglet &quot;Credentials&quot; de cet utilisateur.</p></li><li class="list__item" id="-pzc9yg_99"><p>Cliquez sur &quot;Set password&quot;. Choisissez un mot de passe (ex: `password`), confirmez-le et d&eacute;sactivez &quot;Temporary&quot; pour ne pas avoir &agrave; le changer. Cliquez sur &quot;Save&quot;.</p></li><li class="list__item" id="-pzc9yg_100"><p>Allez dans l'onglet &quot;Role mapping&quot;.</p></li><li class="list__item" id="-pzc9yg_101"><p>Cliquez sur &quot;Assign role&quot;. Filtrez et s&eacute;lectionnez `ROLE_ADMIN`. Cliquez sur &quot;Assign&quot;.</p></li><li class="list__item" id="-pzc9yg_102"><p>R&eacute;p&eacute;tez le processus pour cr&eacute;er un second utilisateur, `simple-user`, avec le mot de passe `password` et assignez-lui uniquement le r&ocirc;le `ROLE_USER`.</p></li></ol><p id="-pzc9yg_67">Notre agence de s&eacute;curit&eacute; est pr&ecirc;te. Elle conna&icirc;t notre application, nos utilisateurs et leurs droits.</p><ol class="list _decimal"></ol></section></section><section class="chapter"><h2 id="tape-3-transformer-product-service-en-resource-server" data-toc="tape-3-transformer-product-service-en-resource-server">&Eacute;tape 3 : Transformer <code class="code" id="-pzc9yg_108">product-service</code> en Resource Server</h2><p id="-pzc9yg_106">Il est temps d'apprendre &agrave; notre service &agrave; utiliser Keycloak.</p><section class="procedure-steps" id="-pzc9yg_107"><p id="-pzc9yg_109"><b id="-pzc9yg_118">3.1. Ajouter les d&eacute;pendances</b></p><p id="-pzc9yg_110">Dans le <code class="code" id="-pzc9yg_119">pom.xml</code> de <code class="code" id="-pzc9yg_120">product-service</code>, ajoutez les d&eacute;pendances pour la s&eacute;curit&eacute; et OAuth2.</p><div class="code-block" data-lang="markup">
&lt;!-- Dans product-service/pom.xml --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-oauth2-resource-server&lt;/artifactId&gt;
&lt;/dependency&gt;


&lt;p&gt;Rechargez les dépendances Maven.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;3.2. Configurer le service&lt;/b&gt;&lt;/p&gt;
&lt;p&gt;Nous devons dire à notre service où trouver Keycloak pour valider les tokens. Dans le dépôt &lt;code&gt;gestbook-config-repo&lt;/code&gt;, ouvrez le fichier &lt;code&gt;product-service.properties&lt;/code&gt; et ajoutez :&lt;/p&gt;
        
```properties
# ... (propriétés existantes)

# ================================

# Configuration OAuth2 Resource Server

# ================================

# URL de l'émetteur (issuer) des tokens. C'est l'URL de notre realm Keycloak.

# Le nom d'hôte 'keycloak' sera résolu par Docker Compose.

spring.security.oauth2.resourceserver.jwt.issuer-uri=http://keycloak:9090/realms/gestbook-realm
</div><p id="-pzc9yg_112">Cette seule ligne est magique. Elle indique &agrave; Spring Security de :</p><ul class="list _bullet" id="-pzc9yg_113"><li class="list__item" id="-pzc9yg_121"><p>Se comporter comme un Resource Server.</p></li><li class="list__item" id="-pzc9yg_122"><p>S'attendre &agrave; des tokens JWT dans les requ&ecirc;tes.</p></li><li class="list__item" id="-pzc9yg_123"><p>Contacter l'URL <code class="code" id="-pzc9yg_124">.../.well-known/openid-configuration</code> de Keycloak pour d&eacute;couvrir automatiquement comment valider les tokens (notamment l'URL de la cl&eacute; publique).</p></li></ul><p id="-pzc9yg_114">Commitez ce changement dans le d&eacute;p&ocirc;t Git.</p><p id="-pzc9yg_115"><b id="-pzc9yg_125">3.3. Cr&eacute;er la configuration de s&eacute;curit&eacute;</b></p><p id="-pzc9yg_116">Cr&eacute;ez un package <code class="code" id="-pzc9yg_126">config</code> dans <code class="code" id="-pzc9yg_127">product-service</code> et ajoutez la classe <code class="code" id="-pzc9yg_128">SecurityConfig</code>.</p><div class="code-block" data-lang="java">
// package fr.formation.spring.productservice.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(authorize -&gt; authorize
                // Tout le monde (authentifié ou non) peut lire les produits
                .requestMatchers(HttpMethod.GET, &quot;/api/products/**&quot;).permitAll()
                // Seuls les utilisateurs avec le rôle 'ADMIN' peuvent en créer
                .requestMatchers(HttpMethod.POST, &quot;/api/products&quot;).hasRole(&quot;ADMIN&quot;)
                // Toutes les autres requêtes doivent être authentifiées
                .anyRequest().authenticated()
            )
            // Configure le service comme un Resource Server OAuth2 qui valide les JWT
            .oauth2ResourceServer(oauth2 -&gt; oauth2.jwt());

        return http.build();
    }
}
</div><ol class="list _decimal"></ol></section></section><section class="chapter"><h2 id="tape-4-le-grand-test" data-toc="tape-4-le-grand-test">&Eacute;tape 4 : Le Grand Test</h2><section class="procedure-steps" id="-pzc9yg_129"><p id="-pzc9yg_131">1. Reconstruisez l'image Docker de `product-service` pour inclure les nouvelles d&eacute;pendances (`mvn clean package`, `docker build ...`).</p><p id="-pzc9yg_132">2. Lancez tout l'&eacute;cosyst&egrave;me : <code class="code" id="-pzc9yg_149">docker-compose up</code>. Assurez-vous que Keycloak a bien d&eacute;marr&eacute;.</p><p id="-pzc9yg_133">3. **Test 1 : Acc&egrave;s non s&eacute;curis&eacute; (devrait fonctionner)**</p><p id="-pzc9yg_134">Faites un appel GET via la Gateway. Aucune s&eacute;curit&eacute; n'est requise, cela doit fonctionner.</p><p> <code class="code" id="-pzc9yg_135">### Get all products (public) GET http://localhost:8080/api/products</code></p><p id="-pzc9yg_136">4. **Test 2 : Acc&egrave;s s&eacute;curis&eacute; SANS token (devrait &eacute;chouer)**</p><p id="-pzc9yg_137">Essayez de cr&eacute;er un produit sans fournir de token.</p><div class="code-block" data-lang="http">
### Create a product WITHOUT token (should fail)
POST http://localhost:8080/api/products
Content-Type: application/json

{ &quot;name&quot;: &quot;Test Book&quot;, &quot;author&quot;: &quot;Test Author&quot;, &quot;price&quot;: 10.0, &quot;stock&quot;: 1 }
</div><p id="-pzc9yg_139">Vous devriez recevoir une r&eacute;ponse <b id="-pzc9yg_150">`401 Unauthorized`</b>. C'est parfait ! Notre service a bien rejet&eacute; la requ&ecirc;te car elle n'&eacute;tait pas authentifi&eacute;e.</p><p id="-pzc9yg_140">5. **Obtenir un token JWT**</p><p id="-pzc9yg_141">C'est l'&eacute;tape la plus d&eacute;licate. Normalement, un front-end g&eacute;rerait &ccedil;a. Nous allons le simuler avec `curl` ou un client API comme Postman.</p><p id="-pzc9yg_142">Ouvrez un terminal et ex&eacute;cutez cette commande `curl` (remplacez-la par l'&eacute;quivalent dans votre client API si vous pr&eacute;f&eacute;rez). Elle demande un token &agrave; Keycloak pour l'utilisateur `admin-user`.</p><div class="code-block" data-lang="bash">
curl --location 'http://localhost:9090/realms/gestbook-realm/protocol/openid-connect/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'client_id=gestbook-api' \
--data-urlencode 'username=admin-user' \
--data-urlencode 'password=password' \
--data-urlencode 'grant_type=password'
</div><p id="-pzc9yg_144">Keycloak va vous renvoyer un JSON. Copiez la valeur du champ <code class="code" id="-pzc9yg_151">access_token</code>. C'est votre pr&eacute;cieux JWT !</p><p id="-pzc9yg_145">6. **Test 3 : Acc&egrave;s s&eacute;curis&eacute; AVEC token (devrait r&eacute;ussir)**</p><p id="-pzc9yg_146">Refaites la m&ecirc;me requ&ecirc;te POST, mais cette fois, ajoutez l'en-t&ecirc;te `Authorization` avec le token.</p><div class="code-block" data-lang="http">
### Create a product WITH ADMIN token (should succeed)
@token = eyJhbGciOiJSUzI1NiIsInR5cCIg... (collez votre token ici)

POST http://localhost:8080/api/products
Content-Type: application/json
Authorization: Bearer {{token}}

{
&quot;name&quot;: &quot;The Lord of the Rings&quot;,
&quot;author&quot;: &quot;J.R.R. Tolkien&quot;,
&quot;price&quot;: 25.50,
&quot;stock&quot;: 100
}
</div><p id="-pzc9yg_148">Cette fois, vous devriez recevoir une r&eacute;ponse <b id="-pzc9yg_152">`201 Created`</b>! La requ&ecirc;te est pass&eacute;e, car le token &eacute;tait valide et contenait le r&ocirc;le `ROLE_ADMIN`.</p><ol class="list _decimal"></ol></section></section><section class="chapter"><h2 id="exercice-12-tester-avec-le-mauvais-r-le" data-toc="exercice-12-tester-avec-le-mauvais-r-le">Exercice 12 : Tester avec le mauvais r&ocirc;le</h2><p id="-pzc9yg_153"><span class="control" id="-pzc9yg_157">Contexte :</span> Nous avons un <code class="code" id="-pzc9yg_158">simple-user</code> qui n'a que le <code class="code" id="-pzc9yg_159">ROLE_USER</code>. Il ne devrait pas pouvoir cr&eacute;er de produits.</p><p id="-pzc9yg_154"><span class="control" id="-pzc9yg_160">Votre mission :</span></p><ol class="list _decimal" id="-pzc9yg_155" type="1"><li class="list__item" id="-pzc9yg_161"><p id="-pzc9yg_165">Utilisez <code class="code" id="-pzc9yg_166">curl</code> (ou votre client API) pour obtenir un token pour <code class="code" id="-pzc9yg_167">simple-user</code>. La commande est la m&ecirc;me, changez juste le <code class="code" id="-pzc9yg_168">username</code>.</p></li><li class="list__item" id="-pzc9yg_162"><p id="-pzc9yg_169">Copiez ce nouveau token.</p></li><li class="list__item" id="-pzc9yg_163"><p id="-pzc9yg_170">Utilisez ce token pour tenter de cr&eacute;er un produit (comme au Test 3).</p></li><li class="list__item" id="-pzc9yg_164"><p id="-pzc9yg_171">Quelle r&eacute;ponse HTTP recevez-vous et pourquoi ?</p></li></ol><section class="chapter"><div class="collapse"><div class="collapse__title"><h3 id="correction-exercice-12" data-toc="correction-exercice-12">Correction exercice 12</h3></div><div class="collapse__content"><ol class="list _decimal" id="-pzc9yg_172" type="1"><li class="list__item" id="-pzc9yg_177"><p id="-pzc9yg_180">La commande pour obtenir le token de <code class="code" id="-pzc9yg_182">simple-user</code> est :</p><div class="code-block" data-lang="bash">
curl ... --data-urlencode 'username=simple-user' ...
</div></li><li class="list__item" id="-pzc9yg_178"><p id="-pzc9yg_183">Vous obtenez un nouveau token. Si vous le d&eacute;codez (par exemple sur jwt.io), vous verrez que le payload contient bien <code class="code" id="-pzc9yg_184">roles: [&quot;ROLE_USER&quot;]</code>.</p></li><li class="list__item" id="-pzc9yg_179"><p id="-pzc9yg_185">et 4. Lorsque vous utilisez ce token pour faire un <code class="code" id="-pzc9yg_186">POST</code> sur <code class="code" id="-pzc9yg_187">/api/products</code>, vous recevrez une r&eacute;ponse * * <code class="code" id="-pzc9yg_188">403 Forbidden</code>**.</p></li></ol><p id="-pzc9yg_173"><span class="control" id="-pzc9yg_189">Pourquoi ?</span></p><ul class="list _bullet" id="-pzc9yg_174"><li class="list__item" id="-pzc9yg_190"><p id="-pzc9yg_192"><span class="control" id="-pzc9yg_193">401 Unauthorized</span> signifie &quot;Je ne sais pas qui vous &ecirc;tes&quot; (vous n'avez pas fourni de laissez-passer valide).</p></li><li class="list__item" id="-pzc9yg_191"><p id="-pzc9yg_194"><span class="control" id="-pzc9yg_195">403 Forbidden</span> signifie &quot;Je sais qui vous &ecirc;tes, mais vous n'avez pas le droit de faire &ccedil;a&quot; (votre laissez-passer est valide, mais il ne vous donne pas acc&egrave;s &agrave; cette zone).</p></li></ul><p id="-pzc9yg_175">C'est exactement ce qui s'est pass&eacute; : le token &eacute;tait valide (authentification r&eacute;ussie), mais il ne contenait pas le r&ocirc;le <code class="code" id="-pzc9yg_196">ADMIN</code> requis par notre <code class="code" id="-pzc9yg_197">SecurityConfig</code> (autorisation &eacute;chou&eacute;e).</p></div></div></section></section><section class="chapter"><h2 id="auto-valuation" data-toc="auto-valuation">Auto-&eacute;valuation</h2><ol class="list _decimal" id="-pzc9yg_198" type="1"><li class="list__item" id="-pzc9yg_200"><p id="-pzc9yg_205"><span class="control" id="-pzc9yg_207">(QCM)</span> Dans Keycloak, qu'est-ce qu'un &quot;Realm&quot; ?</p><ul class="list _bullet" id="-pzc9yg_206"><li class="list__item" id="-pzc9yg_208"><p id="-pzc9yg_212">A) Un utilisateur avec des droits sp&eacute;ciaux.</p></li><li class="list__item" id="-pzc9yg_209"><p id="-pzc9yg_213">B) Une application qui est s&eacute;curis&eacute;e.</p></li><li class="list__item" id="-pzc9yg_210"><p id="-pzc9yg_214">C) Un espace de s&eacute;curit&eacute; isol&eacute; contenant ses propres utilisateurs, clients et r&ocirc;les.</p></li><li class="list__item" id="-pzc9yg_211"><p id="-pzc9yg_215">D) Un r&ocirc;le global.</p></li></ul></li><li class="list__item" id="-pzc9yg_201"><p id="-pzc9yg_216"><span class="control" id="-pzc9yg_217">(Question ouverte)</span> Quelle est l'unique propri&eacute;t&eacute; de configuration minimale requise dans <code class="code" id="-pzc9yg_218">application.properties</code> pour transformer un service Spring Boot en Resource Server qui valide des tokens Keycloak ?</p></li><li class="list__item" id="-pzc9yg_202"><p id="-pzc9yg_219"><span class="control" id="-pzc9yg_221">(QCM)</span> Pour prot&eacute;ger un endpoint afin qu'il ne soit accessible qu'aux utilisateurs authentifi&eacute;s ayant le r&ocirc;le &quot; MANAGER&quot;, quelle expression utiliseriez-vous dans <code class="code" id="-pzc9yg_222">SecurityConfig</code>?</p><ul class="list _bullet" id="-pzc9yg_220"><li class="list__item" id="-pzc9yg_223"><p id="-pzc9yg_227">A) <code class="code" id="-pzc9yg_228">.hasAuthority(&quot;MANAGER&quot;)</code></p></li><li class="list__item" id="-pzc9yg_224"><p id="-pzc9yg_229">B) <code class="code" id="-pzc9yg_230">.isManager()</code></p></li><li class="list__item" id="-pzc9yg_225"><p id="-pzc9yg_231">C) <code class="code" id="-pzc9yg_232">.hasRole(&quot;MANAGER&quot;)</code></p></li><li class="list__item" id="-pzc9yg_226"><p id="-pzc9yg_233">D) <code class="code" id="-pzc9yg_234">.permitAll()</code></p></li></ul></li><li class="list__item" id="-pzc9yg_203"><p id="-pzc9yg_235"><span class="control" id="-pzc9yg_236">(Question ouverte)</span> Quelle est la diff&eacute;rence entre un code de statut HTTP <code class="code" id="-pzc9yg_237">401 Unauthorized</code> et <code class="code" id="-pzc9yg_238">403 Forbidden</code> dans le contexte de la s&eacute;curit&eacute; des API ?</p></li><li class="list__item" id="-pzc9yg_204"><p id="-pzc9yg_239"><span class="control" id="-pzc9yg_241">(QCM)</span> Pour obtenir un token JWT de Keycloak avec <code class="code" id="-pzc9yg_242">curl</code>, quel <code class="code" id="-pzc9yg_243">grant_type</code> est utilis&eacute; pour &eacute;changer un nom d'utilisateur et un mot de passe contre un token ?</p><ul class="list _bullet" id="-pzc9yg_240"><li class="list__item" id="-pzc9yg_244"><p id="-pzc9yg_248">A) <code class="code" id="-pzc9yg_249">client_credentials</code></p></li><li class="list__item" id="-pzc9yg_245"><p id="-pzc9yg_250">B) <code class="code" id="-pzc9yg_251">authorization_code</code></p></li><li class="list__item" id="-pzc9yg_246"><p id="-pzc9yg_252">C) <code class="code" id="-pzc9yg_253">password</code></p></li><li class="list__item" id="-pzc9yg_247"><p id="-pzc9yg_254">D) <code class="code" id="-pzc9yg_255">jwt_bearer</code></p></li></ul></li></ol></section><section class="chapter"><h2 id="conclusion" data-toc="conclusion">Conclusion</h2><p id="-pzc9yg_256">F&eacute;licitations, vous avez franchi une &eacute;tape monumentale ! Votre architecture n'est plus seulement fonctionnelle, elle est maintenant <span class="control" id="-pzc9yg_260">s&eacute;curis&eacute;e</span> selon les standards de l'industrie. Vous avez mis en place une cha&icirc;ne de s&eacute;curit&eacute; compl&egrave;te et robuste.</p><p id="-pzc9yg_257">Vous avez appris &agrave; :</p><ul class="list _bullet" id="-pzc9yg_258"><li class="list__item" id="-pzc9yg_261"><p id="-pzc9yg_266">Orchestrer un serveur d'autorisation <span class="control" id="-pzc9yg_267">Keycloak</span> avec Docker Compose.</p></li><li class="list__item" id="-pzc9yg_262"><p id="-pzc9yg_268">Configurer un environnement de s&eacute;curit&eacute; (realm, client, r&ocirc;les, utilisateurs).</p></li><li class="list__item" id="-pzc9yg_263"><p id="-pzc9yg_269">Transformer un microservice en <span class="control" id="-pzc9yg_270">Resource Server</span> OAuth2 avec une configuration minimale.</p></li><li class="list__item" id="-pzc9yg_264"><p id="-pzc9yg_271">D&eacute;finir des r&egrave;gles d' <span class="control" id="-pzc9yg_272">autorisation</span> granulaires avec Spring Security.</p></li><li class="list__item" id="-pzc9yg_265"><p id="-pzc9yg_273">Manipuler des <span class="control" id="-pzc9yg_274">tokens JWT</span> pour tester votre API.</p></li></ul><p id="-pzc9yg_259">Cette comp&eacute;tence est l'une des plus recherch&eacute;es et des plus critiques pour un Concepteur D&eacute;veloppeur d'Application. Vous &ecirc;tes maintenant pr&ecirc;t &agrave; aborder les derniers piliers d'une architecture de production : l'observabilit&eacute;, avec les logs et les m&eacute;triques.</p></section><div class="last-modified">31 juillet 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="009-00-security.html" class="navigation-links__prev">Module 9 : S&eacute;curit&eacute; Avanc&eacute;e avec Spring Security &amp; OAuth2/OIDC (L'essentiel)</a><a href="010-00-centralized-logs.html" class="navigation-links__next">Module 10 : Logs Centralis&eacute;s (Pattern EFK) - Voir clair dans le brouillard</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.js"></script></body></html>