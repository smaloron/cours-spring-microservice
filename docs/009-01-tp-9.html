<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2025-08-01T06:31:07.127415"><title>TP 9 : &quot;Montrez patte blanche&quot; - S&eacute;curisation de l'API avec Keycloak et Spring Security | Spring Micro Services</title><script type="application/json" id="virtual-toc-data">[{"id":"objectifs-p-dagogiques","level":0,"title":"Objectifs Pédagogiques","anchor":"#objectifs-p-dagogiques"},{"id":"introduction-mettre-en-place-le-service-de-s-curit","level":0,"title":"Introduction : Mettre en place le service de sécurité","anchor":"#introduction-mettre-en-place-le-service-de-s-curit"},{"id":"tape-1-ajout-de-keycloak-docker-compose","level":0,"title":"Étape 1 : Ajout de Keycloak à Docker Compose","anchor":"#tape-1-ajout-de-keycloak-docker-compose"},{"id":"tape-2-configuration-de-keycloak","level":0,"title":"Étape 2 : Configuration de Keycloak","anchor":"#tape-2-configuration-de-keycloak"},{"id":"tape-3-transformer-product-service-en-resource-server","level":0,"title":"Étape 3 : Transformer product-service en Resource Server","anchor":"#tape-3-transformer-product-service-en-resource-server"},{"id":"tape-4-le-grand-test","level":0,"title":"Étape 4 : Le Grand Test","anchor":"#tape-4-le-grand-test"},{"id":"exercice-12-tester-avec-le-mauvais-r-le","level":0,"title":"Exercice 12 : Tester avec le mauvais rôle","anchor":"#exercice-12-tester-avec-le-mauvais-r-le"},{"id":"auto-valuation","level":0,"title":"Auto-évaluation","anchor":"#auto-valuation"},{"id":"conclusion","level":0,"title":"Conclusion","anchor":"#conclusion"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="TP 9 : &quot;Montrez patte blanche&quot; - S&eacute;curisation de l'API avec Keycloak et Spring Security | Spring Micro Services"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="Spring Micro Services Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/009-01-tp-9.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="TP 9 : &quot;Montrez patte blanche&quot; - S&eacute;curisation de l'API avec Keycloak et Spring Security | Spring Micro Services"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/009-01-tp-9.html#webpage",
    "url": "writerside-documentation/009-01-tp-9.html",
    "name": "TP 9 : &quot;Montrez patte blanche&quot; - S&eacute;curisation de l'API avec Keycloak et Spring Security | Spring Micro Services",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "Spring Micro Services Help"
}</script><!-- End Schema.org --></head><body data-id="009-01-TP-9" data-main-title="TP 9 : &quot;Montrez patte blanche&quot; - Sécurisation de l'API avec Keycloak et Spring Security" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="009-00-security.md|Module 9 : Sécurité Avancée avec Spring Security &amp; OAuth2/OIDC (L'essentiel)"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Spring Micro Services  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="009-01-TP-9" id="009-01-TP-9.md">TP 9 : &quot;Montrez patte blanche&quot; - Sécurisation de l'API avec Keycloak et Spring Security</h1><section class="chapter"><h2 id="objectifs-p-dagogiques" data-toc="objectifs-p-dagogiques">Objectifs P&eacute;dagogiques</h2><p id="-yrvqbr_12">&Agrave; la fin de ce TP, vous serez capable de :</p><ul class="list _bullet" id="-yrvqbr_13"><li class="list__item" id="-yrvqbr_14"><p id="-yrvqbr_20">Ajouter Keycloak &agrave; l'orchestration Docker Compose.</p></li><li class="list__item" id="-yrvqbr_15"><p id="-yrvqbr_21">Configurer un &quot;realm&quot;, un &quot;client&quot; et des &quot;utilisateurs/r&ocirc;les&quot; dans Keycloak.</p></li><li class="list__item" id="-yrvqbr_16"><p id="-yrvqbr_22">Configurer un microservice Spring Boot en tant que &quot;Resource Server&quot; OAuth2.</p></li><li class="list__item" id="-yrvqbr_17"><p id="-yrvqbr_23">Prot&eacute;ger des endpoints sp&eacute;cifiques en se basant sur les r&ocirc;les des utilisateurs.</p></li><li class="list__item" id="-yrvqbr_18"><p id="-yrvqbr_24">Obtenir un token JWT depuis Keycloak.</p></li><li class="list__item" id="-yrvqbr_19"><p id="-yrvqbr_25">Tester des endpoints s&eacute;curis&eacute;s et non s&eacute;curis&eacute;s avec un client REST.</p></li></ul></section><section class="chapter"><h2 id="introduction-mettre-en-place-le-service-de-s-curit" data-toc="introduction-mettre-en-place-le-service-de-s-curit">Introduction : Mettre en place le service de s&eacute;curit&eacute;</h2><p id="-yrvqbr_26">Notre club &quot;GestBook&quot; a besoin de son agence de s&eacute;curit&eacute;. Nous allons &quot;embaucher&quot; <span class="control" id="-yrvqbr_29">Keycloak</span> en l'ajoutant &agrave; notre <code class="code" id="-yrvqbr_30">docker-compose.yml</code>. Une fois Keycloak op&eacute;rationnel, nous allons le briefer :</p><ol class="list _decimal" id="-yrvqbr_27" type="1"><li class="list__item" id="-yrvqbr_31"><p id="-yrvqbr_34">Cr&eacute;er notre propre p&eacute;rim&egrave;tre de s&eacute;curit&eacute; (un <code class="code" id="-yrvqbr_35">realm</code>).</p></li><li class="list__item" id="-yrvqbr_32"><p id="-yrvqbr_36">Lui d&eacute;clarer notre application (un <code class="code" id="-yrvqbr_37">client</code>).</p></li><li class="list__item" id="-yrvqbr_33"><p id="-yrvqbr_38">Cr&eacute;er les cartes d'identit&eacute; pour nos employ&eacute;s et nos clients (des <code class="code" id="-yrvqbr_39">users</code> et des <code class="code" id="-yrvqbr_40">roles</code>).</p></li></ol><p id="-yrvqbr_28">Ensuite, nous apprendrons &agrave; notre <code class="code" id="-yrvqbr_41">product-service</code> &agrave; parler &agrave; Keycloak. Nous allons le transformer en &quot;Resource Server&quot; qui saura, pour chaque requ&ecirc;te, v&eacute;rifier la validit&eacute; du &quot;laissez-passer&quot; (le token JWT) et les droits qui y sont associ&eacute;s. &Agrave; la fin, l'ajout d'un nouveau livre ne sera possible que pour un utilisateur ayant le r&ocirc;le d'administrateur.</p></section><section class="chapter"><h2 id="tape-1-ajout-de-keycloak-docker-compose" data-toc="tape-1-ajout-de-keycloak-docker-compose">&Eacute;tape 1 : Ajout de Keycloak &agrave; Docker Compose</h2><section class="procedure-steps" id="-yrvqbr_42"><p id="-yrvqbr_43">Ouvrez votre fichier <code class="code" id="-yrvqbr_49">docker-compose.yml</code> &agrave; la racine du projet.</p><p id="-yrvqbr_44">Ajoutez un nouveau service pour Keycloak. Il est ind&eacute;pendant des autres, il n'a donc pas besoin de <code class="code" id="-yrvqbr_50">depends_on</code>, mais les autres services d&eacute;pendront de lui.</p><div class="code-block" data-lang="yaml">
# Dans docker-compose.yml
services:
  # ... (config-server, eureka-server, etc.)

  # 6. Le Serveur d'Autorisation Keycloak
  keycloak:
    image: quay.io/keycloak/keycloak:24.0.2 # Utilisez une version récente
    ports:
      - &quot;9090:8080&quot; # On mappe le port 8080 de Keycloak au 9090 de notre machine
    environment:
      # Identifiants pour l'admin de Keycloak
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
    # Commande pour démarrer Keycloak en mode développement
    command: start-dev

# ...
</div><p id="-yrvqbr_46">Lancez Keycloak pour la premi&egrave;re fois pour v&eacute;rifier que tout fonctionne :</p><p id="-yrvqbr_48">Attendez que Keycloak ait fini de d&eacute;marrer. Ouvrez votre navigateur &agrave; l'adresse <a href="http://localhost:9090/" id="-yrvqbr_51" data-external="true" rel="noopener noreferrer" target="_blank">http://localhost:9090/</a>. Vous devriez voir la page d'accueil de Keycloak. Cliquez sur &quot;Administration Console&quot; et connectez-vous avec les identifiants que nous avons d&eacute;finis : `admin` / `admin`.</p><ol class="list _decimal"></ol></section></section><section class="chapter"><h2 id="tape-2-configuration-de-keycloak" data-toc="tape-2-configuration-de-keycloak">&Eacute;tape 2 : Configuration de Keycloak</h2><p id="-yrvqbr_52">Nous allons maintenant configurer notre environnement de s&eacute;curit&eacute; via l'interface web de Keycloak.</p><section class="procedure-steps" id="-yrvqbr_53"><p id="-yrvqbr_54"><b id="-yrvqbr_68">2.1. Cr&eacute;er un &quot;Realm&quot;</b></p><p id="-yrvqbr_55">Un realm est un espace de s&eacute;curit&eacute; isol&eacute;. Par d&eacute;faut, vous &ecirc;tes dans le realm `master`. Il est recommand&eacute; de cr&eacute;er un realm d&eacute;di&eacute; pour nos applications.</p><ol class="list _decimal" id="-yrvqbr_56" type="1"><li class="list__item" id="-yrvqbr_69"><p>Passez votre souris sur &quot;master&quot; en haut &agrave; gauche et cliquez sur &quot;Create Realm&quot;.</p></li><li class="list__item" id="-yrvqbr_70"><p>Nom du Realm : <code class="code" id="-yrvqbr_72">gestbook-realm</code>.</p></li><li class="list__item" id="-yrvqbr_71"><p>Cliquez sur &quot;Create&quot;. Vous &ecirc;tes maintenant dans votre nouveau realm.</p></li></ol><figure id="-yrvqbr_57"><img alt="Cr&eacute;er un Realm Keycloak" src="${primarySource}" title="Cr&eacute;er un Realm Keycloak"></figure><p id="-yrvqbr_58"><b id="-yrvqbr_73">2.2. Cr&eacute;er un &quot;Client&quot;</b></p><p id="-yrvqbr_59">Un client repr&eacute;sente une application qui va &ecirc;tre s&eacute;curis&eacute;e par Keycloak.</p><ol class="list _decimal" id="-yrvqbr_60" type="1"><li class="list__item" id="-yrvqbr_74"><p>Dans le menu de gauche, allez dans &quot;Clients&quot;.</p></li><li class="list__item" id="-yrvqbr_75"><p>Cliquez sur &quot;Create client&quot;.</p></li><li class="list__item" id="-yrvqbr_76"><p><b id="-yrvqbr_79">Client ID :</b> <code class="code" id="-yrvqbr_80">gestbook-api</code> (c'est le nom technique de notre application).</p></li><li class="list__item" id="-yrvqbr_77"><p>Cliquez sur &quot;Next&quot;.</p></li><li class="list__item" id="-yrvqbr_78"><p>Laissez les options par d&eacute;faut et cliquez sur &quot;Save&quot;.</p></li></ol><p id="-yrvqbr_61"><b id="-yrvqbr_81">2.3. Cr&eacute;er des R&ocirc;les</b></p><p id="-yrvqbr_62">Nous avons besoin de r&ocirc;les pour d&eacute;finir les autorisations.</p><ol class="list _decimal" id="-yrvqbr_63" type="1"><li class="list__item" id="-yrvqbr_82"><p>Dans le menu de gauche, allez dans &quot;Realm Roles&quot;.</p></li><li class="list__item" id="-yrvqbr_83"><p>Cliquez sur &quot;Create role&quot;.</p></li><li class="list__item" id="-yrvqbr_84"><p><b id="-yrvqbr_87">Role Name :</b> <code class="code" id="-yrvqbr_88">ROLE_ADMIN</code>. Cliquez sur &quot;Save&quot;.</p></li><li class="list__item" id="-yrvqbr_85"><p>Cliquez &agrave; nouveau sur &quot;Create role&quot;.</p></li><li class="list__item" id="-yrvqbr_86"><p><b id="-yrvqbr_89">Role Name :</b> <code class="code" id="-yrvqbr_90">ROLE_USER</code>. Cliquez sur &quot;Save&quot;.</p></li></ol><aside class="prompt" data-type="warning" data-title="" id="-yrvqbr_64"><p><b id="-yrvqbr_91">Convention de nommage Spring Security</b></p><p id="-yrvqbr_92">Il est tr&egrave;s courant de pr&eacute;fixer les r&ocirc;les avec <code class="code" id="-yrvqbr_93">ROLE_</code>. Spring Security peut &ecirc;tre configur&eacute; pour l'attendre par d&eacute;faut, c'est donc une bonne pratique &agrave; prendre.</p></aside><p id="-yrvqbr_65"><b id="-yrvqbr_94">2.4. Cr&eacute;er des Utilisateurs</b></p><ol class="list _decimal" id="-yrvqbr_66" type="1"><li class="list__item" id="-yrvqbr_95"><p>Dans le menu de gauche, allez dans &quot;Users&quot;.</p></li><li class="list__item" id="-yrvqbr_96"><p>Cliquez sur &quot;Create new user&quot;.</p></li><li class="list__item" id="-yrvqbr_97"><p><b id="-yrvqbr_103">Username :</b> <code class="code" id="-yrvqbr_104">admin-user</code>. Cliquez sur &quot;Create&quot;.</p></li><li class="list__item" id="-yrvqbr_98"><p>Allez dans l'onglet &quot;Credentials&quot; de cet utilisateur.</p></li><li class="list__item" id="-yrvqbr_99"><p>Cliquez sur &quot;Set password&quot;. Choisissez un mot de passe (ex: `password`), confirmez-le et d&eacute;sactivez &quot;Temporary&quot; pour ne pas avoir &agrave; le changer. Cliquez sur &quot;Save&quot;.</p></li><li class="list__item" id="-yrvqbr_100"><p>Allez dans l'onglet &quot;Role mapping&quot;.</p></li><li class="list__item" id="-yrvqbr_101"><p>Cliquez sur &quot;Assign role&quot;. Filtrez et s&eacute;lectionnez `ROLE_ADMIN`. Cliquez sur &quot;Assign&quot;.</p></li><li class="list__item" id="-yrvqbr_102"><p>R&eacute;p&eacute;tez le processus pour cr&eacute;er un second utilisateur, `simple-user`, avec le mot de passe `password` et assignez-lui uniquement le r&ocirc;le `ROLE_USER`.</p></li></ol><p id="-yrvqbr_67">Notre agence de s&eacute;curit&eacute; est pr&ecirc;te. Elle conna&icirc;t notre application, nos utilisateurs et leurs droits.</p><ol class="list _decimal"></ol></section></section><section class="chapter"><h2 id="tape-3-transformer-product-service-en-resource-server" data-toc="tape-3-transformer-product-service-en-resource-server">&Eacute;tape 3 : Transformer <code class="code" id="-yrvqbr_108">product-service</code> en Resource Server</h2><p id="-yrvqbr_106">Il est temps d'apprendre &agrave; notre service &agrave; utiliser Keycloak.</p><section class="procedure-steps" id="-yrvqbr_107"><p id="-yrvqbr_109"><b id="-yrvqbr_122">3.1. Ajouter les d&eacute;pendances</b></p><p id="-yrvqbr_110">Dans le <code class="code" id="-yrvqbr_123">pom.xml</code> de <code class="code" id="-yrvqbr_124">product-service</code>, ajoutez les d&eacute;pendances pour la s&eacute;curit&eacute; et OAuth2.</p><div class="code-block" data-lang="markup">
&lt;!-- Dans product-service/pom.xml --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-oauth2-resource-server&lt;/artifactId&gt;
&lt;/dependency&gt;
</div><p id="-yrvqbr_112">Rechargez les d&eacute;pendances Maven.</p><p id="-yrvqbr_113"><b id="-yrvqbr_125">3.2. Configurer le service</b></p><p id="-yrvqbr_114">Nous devons dire &agrave; notre service o&ugrave; trouver Keycloak pour valider les tokens. Dans le d&eacute;p&ocirc;t <code class="code" id="-yrvqbr_126">gestbook-config-repo</code>, ouvrez le fichier <code class="code" id="-yrvqbr_127">product-service.properties</code> et ajoutez :</p><div class="code-block" data-lang="properties">
# ... (propriétés existantes)

# ================================

# Configuration OAuth2 Resource Server

# ================================

# URL de l'émetteur (issuer) des tokens. C'est l'URL de notre realm Keycloak.

# Le nom d'hôte 'keycloak' sera résolu par Docker Compose.

spring.security.oauth2.resourceserver.jwt.issuer-uri=http://keycloak:9090/realms/gestbook-realm
</div><p id="-yrvqbr_116">Cette seule ligne est magique. Elle indique &agrave; Spring Security de :</p><ul class="list _bullet" id="-yrvqbr_117"><li class="list__item" id="-yrvqbr_128"><p>Se comporter comme un Resource Server.</p></li><li class="list__item" id="-yrvqbr_129"><p>S'attendre &agrave; des tokens JWT dans les requ&ecirc;tes.</p></li><li class="list__item" id="-yrvqbr_130"><p>Contacter l'URL <code class="code" id="-yrvqbr_131">.../.well-known/openid-configuration</code> de Keycloak pour d&eacute;couvrir automatiquement comment valider les tokens (notamment l'URL de la cl&eacute; publique).</p></li></ul><p id="-yrvqbr_118">Commitez ce changement dans le d&eacute;p&ocirc;t Git.</p><p id="-yrvqbr_119"><b id="-yrvqbr_132">3.3. Cr&eacute;er la configuration de s&eacute;curit&eacute;</b></p><p id="-yrvqbr_120">Cr&eacute;ez un package <code class="code" id="-yrvqbr_133">config</code> dans <code class="code" id="-yrvqbr_134">product-service</code> et ajoutez la classe <code class="code" id="-yrvqbr_135">SecurityConfig</code>.</p><div class="code-block" data-lang="java">
// package fr.formation.spring.productservice.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(authorize -&gt; authorize
                // Tout le monde (authentifié ou non) peut lire les produits
                .requestMatchers(HttpMethod.GET, &quot;/api/products/**&quot;).permitAll()
                // Seuls les utilisateurs avec le rôle 'ADMIN' peuvent en créer
                .requestMatchers(HttpMethod.POST, &quot;/api/products&quot;).hasRole(&quot;ADMIN&quot;)
                // Toutes les autres requêtes doivent être authentifiées
                .anyRequest().authenticated()
            )
            // Configure le service comme un Resource Server OAuth2 qui valide les JWT
            .oauth2ResourceServer(oauth2 -&gt; oauth2.jwt());

        return http.build();
    }
}
</div><ol class="list _decimal"></ol></section></section><section class="chapter"><h2 id="tape-4-le-grand-test" data-toc="tape-4-le-grand-test">&Eacute;tape 4 : Le Grand Test</h2><section class="procedure-steps" id="-yrvqbr_136"><p id="-yrvqbr_138">1. Reconstruisez l'image Docker de `product-service` pour inclure les nouvelles d&eacute;pendances (`mvn clean package`, `docker build ...`).</p><p id="-yrvqbr_139">2. Lancez tout l'&eacute;cosyst&egrave;me : <code class="code" id="-yrvqbr_156">docker-compose up</code>. Assurez-vous que Keycloak a bien d&eacute;marr&eacute;.</p><p id="-yrvqbr_140">3. **Test 1 : Acc&egrave;s non s&eacute;curis&eacute; (devrait fonctionner)**</p><p id="-yrvqbr_141">Faites un appel GET via la Gateway. Aucune s&eacute;curit&eacute; n'est requise, cela doit fonctionner.</p><p> <code class="code" id="-yrvqbr_142">### Get all products (public) GET http://localhost:8080/api/products</code></p><p id="-yrvqbr_143">4. **Test 2 : Acc&egrave;s s&eacute;curis&eacute; SANS token (devrait &eacute;chouer)**</p><p id="-yrvqbr_144">Essayez de cr&eacute;er un produit sans fournir de token.</p><div class="code-block" data-lang="http">
### Create a product WITHOUT token (should fail)
POST http://localhost:8080/api/products
Content-Type: application/json

{ &quot;name&quot;: &quot;Test Book&quot;, &quot;author&quot;: &quot;Test Author&quot;, &quot;price&quot;: 10.0, &quot;stock&quot;: 1 }
</div><p id="-yrvqbr_146">Vous devriez recevoir une r&eacute;ponse <b id="-yrvqbr_157">`401 Unauthorized`</b>. C'est parfait ! Notre service a bien rejet&eacute; la requ&ecirc;te car elle n'&eacute;tait pas authentifi&eacute;e.</p><p id="-yrvqbr_147">5. **Obtenir un token JWT**</p><p id="-yrvqbr_148">C'est l'&eacute;tape la plus d&eacute;licate. Normalement, un front-end g&eacute;rerait &ccedil;a. Nous allons le simuler avec `curl` ou un client API comme Postman.</p><p id="-yrvqbr_149">Ouvrez un terminal et ex&eacute;cutez cette commande `curl` (remplacez-la par l'&eacute;quivalent dans votre client API si vous pr&eacute;f&eacute;rez). Elle demande un token &agrave; Keycloak pour l'utilisateur `admin-user`.</p><div class="code-block" data-lang="bash">
curl --location 'http://localhost:9090/realms/gestbook-realm/protocol/openid-connect/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'client_id=gestbook-api' \
--data-urlencode 'username=admin-user' \
--data-urlencode 'password=password' \
--data-urlencode 'grant_type=password'
</div><p id="-yrvqbr_151">Keycloak va vous renvoyer un JSON. Copiez la valeur du champ <code class="code" id="-yrvqbr_158">access_token</code>. C'est votre pr&eacute;cieux JWT !</p><p id="-yrvqbr_152">6. **Test 3 : Acc&egrave;s s&eacute;curis&eacute; AVEC token (devrait r&eacute;ussir)**</p><p id="-yrvqbr_153">Refaites la m&ecirc;me requ&ecirc;te POST, mais cette fois, ajoutez l'en-t&ecirc;te `Authorization` avec le token.</p><div class="code-block" data-lang="http">
### Create a product WITH ADMIN token (should succeed)
@token = eyJhbGciOiJSUzI1NiIsInR5cCIg... (collez votre token ici)

POST http://localhost:8080/api/products
Content-Type: application/json
Authorization: Bearer {{token}}

{
&quot;name&quot;: &quot;The Lord of the Rings&quot;,
&quot;author&quot;: &quot;J.R.R. Tolkien&quot;,
&quot;price&quot;: 25.50,
&quot;stock&quot;: 100
}
</div><p id="-yrvqbr_155">Cette fois, vous devriez recevoir une r&eacute;ponse <b id="-yrvqbr_159">`201 Created`</b>! La requ&ecirc;te est pass&eacute;e, car le token &eacute;tait valide et contenait le r&ocirc;le `ROLE_ADMIN`.</p><ol class="list _decimal"></ol></section></section><section class="chapter"><h2 id="exercice-12-tester-avec-le-mauvais-r-le" data-toc="exercice-12-tester-avec-le-mauvais-r-le">Exercice 12 : Tester avec le mauvais r&ocirc;le</h2><p id="-yrvqbr_160"><span class="control" id="-yrvqbr_164">Contexte :</span> Nous avons un <code class="code" id="-yrvqbr_165">simple-user</code> qui n'a que le <code class="code" id="-yrvqbr_166">ROLE_USER</code>. Il ne devrait pas pouvoir cr&eacute;er de produits.</p><p id="-yrvqbr_161"><span class="control" id="-yrvqbr_167">Votre mission :</span></p><ol class="list _decimal" id="-yrvqbr_162" type="1"><li class="list__item" id="-yrvqbr_168"><p id="-yrvqbr_172">Utilisez <code class="code" id="-yrvqbr_173">curl</code> (ou votre client API) pour obtenir un token pour <code class="code" id="-yrvqbr_174">simple-user</code>. La commande est la m&ecirc;me, changez juste le <code class="code" id="-yrvqbr_175">username</code>.</p></li><li class="list__item" id="-yrvqbr_169"><p id="-yrvqbr_176">Copiez ce nouveau token.</p></li><li class="list__item" id="-yrvqbr_170"><p id="-yrvqbr_177">Utilisez ce token pour tenter de cr&eacute;er un produit (comme au Test 3).</p></li><li class="list__item" id="-yrvqbr_171"><p id="-yrvqbr_178">Quelle r&eacute;ponse HTTP recevez-vous et pourquoi ?</p></li></ol><section class="chapter"><div class="collapse"><div class="collapse__title"><h3 id="correction-exercice-12" data-toc="correction-exercice-12">Correction exercice 12</h3></div><div class="collapse__content"><ol class="list _decimal" id="-yrvqbr_179" type="1"><li class="list__item" id="-yrvqbr_184"><p id="-yrvqbr_187">La commande pour obtenir le token de <code class="code" id="-yrvqbr_189">simple-user</code> est :</p><div class="code-block" data-lang="bash">
curl ... --data-urlencode 'username=simple-user' ...
</div></li><li class="list__item" id="-yrvqbr_185"><p id="-yrvqbr_190">Vous obtenez un nouveau token. Si vous le d&eacute;codez (par exemple sur jwt.io), vous verrez que le payload contient bien <code class="code" id="-yrvqbr_191">roles: [&quot;ROLE_USER&quot;]</code>.</p></li><li class="list__item" id="-yrvqbr_186"><p id="-yrvqbr_192">et 4. Lorsque vous utilisez ce token pour faire un <code class="code" id="-yrvqbr_193">POST</code> sur <code class="code" id="-yrvqbr_194">/api/products</code>, vous recevrez une r&eacute;ponse * * <code class="code" id="-yrvqbr_195">403 Forbidden</code>**.</p></li></ol><p id="-yrvqbr_180"><span class="control" id="-yrvqbr_196">Pourquoi ?</span></p><ul class="list _bullet" id="-yrvqbr_181"><li class="list__item" id="-yrvqbr_197"><p id="-yrvqbr_199"><span class="control" id="-yrvqbr_200">401 Unauthorized</span> signifie &quot;Je ne sais pas qui vous &ecirc;tes&quot; (vous n'avez pas fourni de laissez-passer valide).</p></li><li class="list__item" id="-yrvqbr_198"><p id="-yrvqbr_201"><span class="control" id="-yrvqbr_202">403 Forbidden</span> signifie &quot;Je sais qui vous &ecirc;tes, mais vous n'avez pas le droit de faire &ccedil;a&quot; (votre laissez-passer est valide, mais il ne vous donne pas acc&egrave;s &agrave; cette zone).</p></li></ul><p id="-yrvqbr_182">C'est exactement ce qui s'est pass&eacute; : le token &eacute;tait valide (authentification r&eacute;ussie), mais il ne contenait pas le r&ocirc;le <code class="code" id="-yrvqbr_203">ADMIN</code> requis par notre <code class="code" id="-yrvqbr_204">SecurityConfig</code> (autorisation &eacute;chou&eacute;e).</p></div></div></section></section><section class="chapter"><h2 id="auto-valuation" data-toc="auto-valuation">Auto-&eacute;valuation</h2><ol class="list _decimal" id="-yrvqbr_205" type="1"><li class="list__item" id="-yrvqbr_207"><p id="-yrvqbr_212"><span class="control" id="-yrvqbr_214">(QCM)</span> Dans Keycloak, qu'est-ce qu'un &quot;Realm&quot; ?</p><ul class="list _bullet" id="-yrvqbr_213"><li class="list__item" id="-yrvqbr_215"><p id="-yrvqbr_219">A) Un utilisateur avec des droits sp&eacute;ciaux.</p></li><li class="list__item" id="-yrvqbr_216"><p id="-yrvqbr_220">B) Une application qui est s&eacute;curis&eacute;e.</p></li><li class="list__item" id="-yrvqbr_217"><p id="-yrvqbr_221">C) Un espace de s&eacute;curit&eacute; isol&eacute; contenant ses propres utilisateurs, clients et r&ocirc;les.</p></li><li class="list__item" id="-yrvqbr_218"><p id="-yrvqbr_222">D) Un r&ocirc;le global.</p></li></ul></li><li class="list__item" id="-yrvqbr_208"><p id="-yrvqbr_223"><span class="control" id="-yrvqbr_224">(Question ouverte)</span> Quelle est l'unique propri&eacute;t&eacute; de configuration minimale requise dans <code class="code" id="-yrvqbr_225">application.properties</code> pour transformer un service Spring Boot en Resource Server qui valide des tokens Keycloak ?</p></li><li class="list__item" id="-yrvqbr_209"><p id="-yrvqbr_226"><span class="control" id="-yrvqbr_228">(QCM)</span> Pour prot&eacute;ger un endpoint afin qu'il ne soit accessible qu'aux utilisateurs authentifi&eacute;s ayant le r&ocirc;le &quot; MANAGER&quot;, quelle expression utiliseriez-vous dans <code class="code" id="-yrvqbr_229">SecurityConfig</code>?</p><ul class="list _bullet" id="-yrvqbr_227"><li class="list__item" id="-yrvqbr_230"><p id="-yrvqbr_234">A) <code class="code" id="-yrvqbr_235">.hasAuthority(&quot;MANAGER&quot;)</code></p></li><li class="list__item" id="-yrvqbr_231"><p id="-yrvqbr_236">B) <code class="code" id="-yrvqbr_237">.isManager()</code></p></li><li class="list__item" id="-yrvqbr_232"><p id="-yrvqbr_238">C) <code class="code" id="-yrvqbr_239">.hasRole(&quot;MANAGER&quot;)</code></p></li><li class="list__item" id="-yrvqbr_233"><p id="-yrvqbr_240">D) <code class="code" id="-yrvqbr_241">.permitAll()</code></p></li></ul></li><li class="list__item" id="-yrvqbr_210"><p id="-yrvqbr_242"><span class="control" id="-yrvqbr_243">(Question ouverte)</span> Quelle est la diff&eacute;rence entre un code de statut HTTP <code class="code" id="-yrvqbr_244">401 Unauthorized</code> et <code class="code" id="-yrvqbr_245">403 Forbidden</code> dans le contexte de la s&eacute;curit&eacute; des API ?</p></li><li class="list__item" id="-yrvqbr_211"><p id="-yrvqbr_246"><span class="control" id="-yrvqbr_248">(QCM)</span> Pour obtenir un token JWT de Keycloak avec <code class="code" id="-yrvqbr_249">curl</code>, quel <code class="code" id="-yrvqbr_250">grant_type</code> est utilis&eacute; pour &eacute;changer un nom d'utilisateur et un mot de passe contre un token ?</p><ul class="list _bullet" id="-yrvqbr_247"><li class="list__item" id="-yrvqbr_251"><p id="-yrvqbr_255">A) <code class="code" id="-yrvqbr_256">client_credentials</code></p></li><li class="list__item" id="-yrvqbr_252"><p id="-yrvqbr_257">B) <code class="code" id="-yrvqbr_258">authorization_code</code></p></li><li class="list__item" id="-yrvqbr_253"><p id="-yrvqbr_259">C) <code class="code" id="-yrvqbr_260">password</code></p></li><li class="list__item" id="-yrvqbr_254"><p id="-yrvqbr_261">D) <code class="code" id="-yrvqbr_262">jwt_bearer</code></p></li></ul></li></ol></section><section class="chapter"><h2 id="conclusion" data-toc="conclusion">Conclusion</h2><p id="-yrvqbr_263">F&eacute;licitations, vous avez franchi une &eacute;tape monumentale ! Votre architecture n'est plus seulement fonctionnelle, elle est maintenant <span class="control" id="-yrvqbr_267">s&eacute;curis&eacute;e</span> selon les standards de l'industrie. Vous avez mis en place une cha&icirc;ne de s&eacute;curit&eacute; compl&egrave;te et robuste.</p><p id="-yrvqbr_264">Vous avez appris &agrave; :</p><ul class="list _bullet" id="-yrvqbr_265"><li class="list__item" id="-yrvqbr_268"><p id="-yrvqbr_273">Orchestrer un serveur d'autorisation <span class="control" id="-yrvqbr_274">Keycloak</span> avec Docker Compose.</p></li><li class="list__item" id="-yrvqbr_269"><p id="-yrvqbr_275">Configurer un environnement de s&eacute;curit&eacute; (realm, client, r&ocirc;les, utilisateurs).</p></li><li class="list__item" id="-yrvqbr_270"><p id="-yrvqbr_276">Transformer un microservice en <span class="control" id="-yrvqbr_277">Resource Server</span> OAuth2 avec une configuration minimale.</p></li><li class="list__item" id="-yrvqbr_271"><p id="-yrvqbr_278">D&eacute;finir des r&egrave;gles d' <span class="control" id="-yrvqbr_279">autorisation</span> granulaires avec Spring Security.</p></li><li class="list__item" id="-yrvqbr_272"><p id="-yrvqbr_280">Manipuler des <span class="control" id="-yrvqbr_281">tokens JWT</span> pour tester votre API.</p></li></ul><p id="-yrvqbr_266">Cette comp&eacute;tence est l'une des plus recherch&eacute;es et des plus critiques pour un Concepteur D&eacute;veloppeur d'Application. Vous &ecirc;tes maintenant pr&ecirc;t &agrave; aborder les derniers piliers d'une architecture de production : l'observabilit&eacute;, avec les logs et les m&eacute;triques.</p></section><div class="last-modified">01 août 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="009-00-security.html" class="navigation-links__prev">Module 9 : S&eacute;curit&eacute; Avanc&eacute;e avec Spring Security &amp; OAuth2/OIDC (L'essentiel)</a><a href="010-00-centralized-logs.html" class="navigation-links__next">Module 10 : Logs Centralis&eacute;s (Pattern EFK) - Voir clair dans le brouillard</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.js"></script></body></html>